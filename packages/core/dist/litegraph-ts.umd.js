(function(D,J){typeof exports=="object"&&typeof module<"u"?J(exports):typeof define=="function"&&define.amd?define(["exports"],J):(D=typeof globalThis<"u"?globalThis:D||self,J(D["litegraph-ts"]={}))})(this,function(D){"use strict";class J{constructor(e,i,n,s,r,a){this.data=null,this._pos=[0,0],this._last_time=0,this.id=e,this.type=i,this.origin_id=n,this.origin_slot=s,this.target_id=r,this.target_slot=a}static configure(e){return e instanceof Array?new J(e[0],e[5],e[1],e[2],e[3],e[4]):new J(e.id,e.type,e.origin_id,e.origin_slot,e.target_id,e.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}var I=(t=>(t[t.UP=1]="UP",t[t.DOWN=2]="DOWN",t[t.LEFT=3]="LEFT",t[t.RIGHT=4]="RIGHT",t[t.CENTER=5]="CENTER",t))(I||{}),j=(t=>(t[t.ALWAYS=0]="ALWAYS",t[t.ON_EVENT=1]="ON_EVENT",t[t.NEVER=2]="NEVER",t[t.ON_TRIGGER=3]="ON_TRIGGER",t[t.ON_REQUEST=4]="ON_REQUEST",t))(j||{});const ne=["Always","On Event","Never","On Trigger"],_e=["#666","#422","#333","#224","#626"];var S=(t=>(t[t.DEFAULT=0]="DEFAULT",t[t.BOX_SHAPE=1]="BOX_SHAPE",t[t.ROUND_SHAPE=2]="ROUND_SHAPE",t[t.CIRCLE_SHAPE=3]="CIRCLE_SHAPE",t[t.CARD_SHAPE=4]="CARD_SHAPE",t[t.ARROW_SHAPE=5]="ARROW_SHAPE",t[t.GRID_SHAPE=6]="GRID_SHAPE",t))(S||{});const ve=["default","box","round","circle","card","arrow","square"];var U=(t=>(t[t.INPUT=0]="INPUT",t[t.OUTPUT=1]="OUTPUT",t))(U||{}),ae=(t=>(t[t.STRAIGHT_LINK=0]="STRAIGHT_LINK",t[t.LINEAR_LINK=1]="LINEAR_LINK",t[t.SPLINE_LINK=2]="SPLINE_LINK",t))(ae||{});const Se=["Straight","Linear","Spline"];var ee=(t=>(t[t.NORMAL_TITLE=0]="NORMAL_TITLE",t[t.NO_TITLE=1]="NO_TITLE",t[t.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",t[t.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",t))(ee||{}),k=(t=>(t[t.EVENT=-2]="EVENT",t[t.ACTION=-1]="ACTION",t[t.DEFAULT=0]="DEFAULT",t))(k||{}),re=(t=>(t.VERTICAL_LAYOUT="vertical",t.HORIZONTAL_LAYOUT="horizontal",t))(re||{});function me(t,e){return e in t?t[e]:null}function fe(t,e){return e in t.constructor?t.constructor[e]:null}const ye=class{constructor(t){this.desc="",this.pos=[0,0],this.subgraph=null,this.skip_subgraph_button=!1,this.priority=0,this.removable=!0,this.clonable=!0,this.collapsable=!0,this.titleMode=ee.NORMAL_TITLE,this.serialize_widgets=!1,this.skip_list=!1,this.block_delete=!1,this.ignore_remove=!1,this.last_serialization=null,this._relative_id=null,this.exec_version=0,this.action_call=null,this.execute_triggered=0,this.action_triggered=0,this.console=[],this.title=t||"Unnamed",this.size=[h.NODE_WIDTH,60],this.graph=null,this.pos=[10,10],this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}get slotLayout(){return"slotLayout"in this.constructor?this.constructor.slotLayout:null}configure(t){this.graph&&this.graph._version++;for(var e in t){if(e=="properties"){for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);continue}t[e]!=null&&(typeof t[e]=="object"?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=h.cloneObject(t[e],this[e]):this[e]=t[e])}if(t.title||(this.title=fe(this,"title")||this.title),this.inputs)for(let r=0;r<this.inputs.length;++r){let a=this.inputs[r],l=this.graph?this.graph.links[a.link]:null;this.onConnectionsChange&&this.onConnectionsChange(U.INPUT,r,!0,l,a),this.onInputAdded&&this.onInputAdded(a)}if(this.outputs)for(var n=0;n<this.outputs.length;++n){let r=this.outputs[n];if(r.links){for(let a=0;a<r.links.length;++a){let l=this.graph?this.graph.links[r.links[a]]:null;this.onConnectionsChange&&this.onConnectionsChange(U.OUTPUT,n,!0,l,r)}this.onOutputAdded&&this.onOutputAdded(r)}}if(this.widgets){for(var n=0;n<this.widgets.length;++n){var s=this.widgets[n];s&&s.options&&s.options.property&&this.properties[s.options.property]&&(s.value=JSON.parse(JSON.stringify(this.properties[s.options.property])))}if(t.widgets_values)for(var n=0;n<t.widgets_values.length;++n)this.widgets[n]&&(this.widgets[n].value=t.widgets_values[n])}this.onConfigure&&this.onConfigure(t)}serialize(){let t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:h.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===ye&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=h.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(var e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgColor&&(t.bgcolor=this.bgColor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){var t=h.createNode(this.type);if(!t)return null;var e=h.cloneObject(this.serialize());if(e.inputs)for(var i=0;i<e.inputs.length;++i)e.inputs[i].link=null;if(e.outputs)for(var i=0;i<e.outputs.length;++i)e.outputs[i].links&&(e.outputs[i].links.length=0);return delete e.id,t.configure(e),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var i=this.properties[t];if(this.properties[t]=e,this.graph&&this.graph._version++,this.onPropertyChanged&&this.onPropertyChanged(t,e,i)===!1&&(this.properties[t]=i),this.widgets)for(var n=0;n<this.widgets.length;++n){var s=this.widgets[n];if(s&&s.options.property==t){s.value=e;break}}}}setOutputData(t,e){if(this.outputs&&!(t==-1||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i._data=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n],r=this.graph.links[s];r&&(r.data=e)}}}setOutputDataType(t,e){if(this.outputs&&!(t==-1||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.type=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n];this.graph.links[s].type=e}}}getInputData(t,e){if(this.inputs&&!(t>=this.inputs.length||this.inputs[t].link==null)){var i=this.inputs[t].link,n=this.graph.links[i];if(!n)return console.error(`No input node found in slot ${t}!`,this,this.inputs[t]),null;if(!e)return n.data;var s=this.graph.getNodeById(n.origin_id);return s&&(s.updateOutputData?s.updateOutputData(n.origin_slot):s.onExecute&&s.onExecute(null,{})),n.data}}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;var e=this.inputs[t].link,i=this.graph.links[e];if(!i)return console.error(`No input node found in slot ${t}!`,this,this.inputs[t]),null;var n=this.graph.getNodeById(i.origin_id);if(!n)return i.type;var s=n.outputs[i.origin_slot];return s&&s.type!=-1?s.type:null}getInputDataByName(t,e){var i=this.findInputSlotIndexByName(t);return i==-1?null:this.getInputData(i,e)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null}getInputNode(t){if(!this.inputs)return null;if(t<this.inputs.length){const i=this.inputs[t].link,n=this.graph.links[i];if(!n)return console.error(`No input node found in slot ${t}!`,this,this.inputs[t]),null;var e=this.graph.getNodeById(n.origin_id);if(e)return e}return null}getInputOrProperty(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,i=this.inputs.length;e<i;++e){var n=this.inputs[e];if(t==n.name&&n.link!=null){var s=this.graph.links[n.link];if(s)return s.data}}return this.properties[t]}getOutputData(t){if(!this.outputs||t>=this.outputs.length)return null;var e=this.outputs[t];return e._data}getOutputLinks(t){if(!this.outputs)return null;if(t>=0&&t<this.outputs.length){var e=this.outputs[t],i=[];for(const n in e.links)i.push(this.graph.links[n]);return i}return null}getOutputInfo(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}isOutputConnected(t){return this.outputs?t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length>0:!1}isAnyOutputConnected(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1}getOutputNodes(t){if(!this.outputs||this.outputs.length==0||t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||e.links.length==0)return null;for(var i=[],n=0;n<e.links.length;n++){var s=e.links[n],r=this.graph.links[s];if(r){var a=this.graph.getNodeById(r.target_id);a&&i.push(a)}}return i}addOnTriggerInput(){var t=this.findInputSlotIndexByName("onTrigger");if(t==-1){//!trigS ||
return this.addInput("onTrigger",k.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlotIndexByName("onTrigger")}return t}addOnExecutedOutput(){var t=this.findOutputSlotIndexByName("onExecuted");if(t==-1){//!trigS ||
return this.addOutput("onExecuted",k.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlotIndexByName("onExecuted")}return t}onAfterExecuteNode(t,e){var i=this.findOutputSlotIndexByName("onExecuted");i!=-1&&this.triggerSlot(i,t,null,e)}changeMode(t){switch(t){case j.ON_EVENT:break;case j.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case j.NEVER:break;case j.ALWAYS:break;case j.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,e={}){this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)}actionDo(t,e,i={}){this.onAction&&(i.action_call||(i.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,i),this.graph.nodes_actioning[this.id]=!1,i&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,i)}trigger(t,e,i){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=h.getTime());for(var n=0;n<this.outputs.length;++n){var s=this.outputs[n];!s||s.type!==k.EVENT||t&&s.name!=t||this.triggerSlot(n,e,null,i)}}}triggerSlot(t,e,i,n={}){if(this.outputs){if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var s=this.outputs[t];if(s){var r=s.links;if(!(!r||!r.length)){this.graph&&(this.graph._last_trigger_time=h.getTime());for(var a=0;a<r.length;++a){var l=r[a];if(!(i!=null&&i!=l)){var o=this.graph.links[r[a]];if(o){o._last_time=h.getTime();var u=this.graph.getNodeById(o.target_id);if(u){var p=u.inputs[o.target_slot];if(u.mode===j.ON_TRIGGER)n.action_call||(n.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),u.onExecute&&u.doExecute(e,n);else if(u.onAction){n.action_call||(n.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));var p=u.inputs[o.target_slot];u.actionDo(p.name,e,n)}}}}}}}}}clearTriggeredSlot(t,e){if(this.outputs){var i=this.outputs[t];if(i){var n=i.links;if(!(!n||!n.length))for(var s=0;s<n.length;++s){var r=n[s];if(!(e!=null&&e!=r)){var a=this.graph.links[n[s]];a&&(a._last_time=0)}}}}}setSize(t){this.size=t,this.onResize&&this.onResize(this.size)}addProperty(t,e,i,n){var s={name:t,type:i,default_value:e};if(n)for(var r in n)s[r]=n[r];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s}addOutput(t,e=k.DEFAULT,i){var n={name:t,type:e,links:null};if(i)for(var s in i)n[s]=i[s];return e=="array"&&(n.shape==null||n.shape==S.DEFAULT)&&(n.shape=S.GRID_SHAPE),this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),h.auto_load_slot_types&&h.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),n}removeOutput(t){const e=this.outputs[t];this.disconnectOutput(t),this.outputs.splice(t,1);for(var i=t;i<this.outputs.length;++i)if(!(!this.outputs[i]||!this.outputs[i].links))for(var n=this.outputs[i].links,s=0;s<n.length;++s){var r=this.graph.links[n[s]];r&&(r.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t,e),this.setDirtyCanvas(!0,!0)}addInput(t,e=k.DEFAULT,i){var n={name:t,type:e,link:null};if(i)for(var s in i)n[s]=i[s];return e=="array"&&(n.shape==null||n.shape==S.DEFAULT)&&(n.shape=S.GRID_SHAPE),this.inputs||(this.inputs=[]),this.inputs.push(n),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(n),h.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),n}removeInput(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),i=t;i<this.inputs.length;++i)if(this.inputs[i]){var n=this.graph.links[this.inputs[i].link];n&&(n.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)}addConnection(t,e,i,n){let s={name:t,type:e,pos:i,direction:n,links:null};return this.connections.push(s),s}computeSize(t=[0,0]){const e=fe(this,"overrideSize");if(e)return e.concat();var i=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=t;i=Math.max(i,1);var s=h.NODE_TEXT_SIZE,r=g(this.title),a=0,l=0;if(this.inputs)for(var o=0,u=this.inputs.length;o<u;++o){var p=this.inputs[o],d=p.label||p.name||"",c=g(d);a<c&&(a=c)}if(this.outputs)for(var o=0,u=this.outputs.length;o<u;++o){var _=this.outputs[o],d=_.label||_.name||"",c=g(d);l<c&&(l=c)}n[0]=Math.max(a+l+10,r),n[0]=Math.max(n[0],h.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],h.NODE_WIDTH*1.5)),n[1]=(this.constructor.slot_start_y||0)+i*h.NODE_SLOT_HEIGHT;var f=0;if(this.widgets&&this.widgets.length){for(var o=0,u=this.widgets.length;o<u;++o)this.widgets[o].computeSize?f+=this.widgets[o].computeSize(n[0])[1]+4:f+=h.NODE_WIDGET_HEIGHT+4;f+=8}this.widgets_up?n[1]=Math.max(n[1],f):this.widgets_start_y!=null?n[1]=Math.max(n[1],f+this.widgets_start_y):n[1]+=f;function g(m){return m?s*m.length*.6:0}return this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n}getPropertyInfo(t){var e=null;if(this.properties_info){for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=typeof this.properties[t]),e.widget=="combo"&&(e.type="enum"),e}addWidget(t,e,i,n,s){this.widgets||(this.widgets=[]),!s&&n&&n.constructor===Object&&(s=n,n=null),s&&s.constructor===String&&(s={property:s}),n&&n.constructor===String&&(s||(s={}),s.property=n,n=null),n&&n.constructor!==Function&&(console.warn("addWidget: callback must be a function"),n=null);var r={type:t.toLowerCase(),name:e,value:i,callback:n,options:s||{}};if(r.options.y!==void 0&&(r.y=r.options.y),!n&&!r.options.callback&&!r.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(r),this.setSize(this.computeSize()),r}addCustomWidget(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t}getBounding(t){return t=t||new Float32Array(4),t[0]=this.pos[0]-4,t[1]=this.pos[1]-h.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.flags.collapsed?h.NODE_TITLE_HEIGHT:this.size[1]+h.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t}isPointInside(t,e,i=0,n=!1){var s=this.graph&&this.graph.isLive()?0:h.NODE_TITLE_HEIGHT;if(n&&(s=0),this.flags&&this.flags.collapsed){if(h.isInsideRectangle(t,e,this.pos[0]-i,this.pos[1]-h.NODE_TITLE_HEIGHT-i,(this._collapsed_width||h.NODE_COLLAPSED_WIDTH)+2*i,h.NODE_TITLE_HEIGHT+2*i))return!0}else if(this.pos[0]-4-i<t&&this.pos[0]+this.size[0]+4+i>t&&this.pos[1]-s-i<e&&this.pos[1]+this.size[1]+i>e)return!0;return!1}getSlotInPosition(t,e){var i=[0,0];if(this.inputs)for(var n=0,s=this.inputs.length;n<s;++n){var r=this.inputs[n];if(this.getConnectionPos(!0,n,i),h.isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{input:r,slot:n,link_pos:i}}if(this.outputs)for(var n=0,s=this.outputs.length;n<s;++n){var a=this.outputs[n];if(this.getConnectionPos(!1,n,i),h.isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{output:a,slot:n,link_pos:i}}return null}findInputSlotIndexByName(t,e=!1,i){if(!this.inputs)return-1;for(var n=0,s=this.inputs.length;n<s;++n)if(!(e&&this.inputs[n].link&&this.inputs[n].link!=null)&&!(i&&i.includes(this.inputs[n].type))&&(!t||t==this.inputs[n].name))return n;return-1}findInputSlotByName(t,e=!1,i){if(!this.inputs)return null;for(var n=0,s=this.inputs.length;n<s;++n)if(!(e&&this.inputs[n].link&&this.inputs[n].link!=null)&&!(i&&i.includes(this.inputs[n].type))&&(!t||t==this.inputs[n].name))return this.inputs[n];return null}findOutputSlotIndexByName(t,e=!1,i){if(!this.outputs)return-1;for(var n=0,s=this.outputs.length;n<s;++n)if(!(e&&this.outputs[n].links&&this.outputs[n].links!=null)&&!(i&&i.includes(this.outputs[n].type))&&(!t||t==this.outputs[n].name))return n;return-1}findOutputSlotByName(t,e=!1,i){if(!this.outputs)return null;for(var n=0,s=this.outputs.length;n<s;++n)if(!(e&&this.outputs[n].links&&this.outputs[n].links!=null)&&!(i&&i.includes(this.outputs[n].type))&&(!t||t==this.outputs[n].name))return this.outputs[n];return null}findInputSlotIndexByType(t,e=!1,i=!1){return this.findSlotByType(!0,t,!1,e,i)}findOutputSlotIndexByType(t,e=!1,i=!1){return this.findSlotByType(!1,t,!1,e,i)}findInputSlotByType(t,e=!1,i=!1){return this.findSlotByType(!0,t,!1,e,i)}findOutputSlotByType(t,e=!1,i=!1){return this.findSlotByType(!1,t,!1,e,i)}findSlotByType(t,e,i,n=!1,s=!1){n=n||!1,s=s||!1;var r=t?this.inputs:this.outputs;if(!r)return i?null:-1;(e==""||e=="*")&&(e=0);for(var a=0,l=r.length;a<l;++a){var o=(e+"").toLowerCase().split(","),u=r[a].type=="0"||r[a].type=="*"?"0":r[a].type;let p=(u+"").toLowerCase().split(",");for(let d=0;d<o.length;d++)for(let c=0;c<p.length;c++)if(o[d]=="_event_"&&(o[d]=k.EVENT),p[d]=="_event_"&&(p[d]=k.EVENT),o[d]=="*"&&(o[d]=k.DEFAULT),p[d]=="*"&&(p[d]=k.DEFAULT),o[d]==p[c]){let _=r[a];if(n&&_.links&&_.links!==null||_.link&&_.link!==null)continue;return i?_:a}}if(n&&!s)for(var a=0,l=r.length;a<l;++a){var o=(e+"").toLowerCase().split(","),u=r[a].type=="0"||r[a].type=="*"?"0":r[a].type;let f=(u+"").toLowerCase().split(",");for(let g=0;g<o.length;g++)for(let m=0;m<f.length;m++)if(o[g]=="*"&&(o[g]=k.DEFAULT),f[g]=="*"&&(f[g]=k.DEFAULT),o[g]==f[m])return i?r[a]:a}return i?null:-1}connectByTypeInput(t,e,i,n={}){var s={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},r=Object.assign(s,n);e&&e.constructor===Number&&(e=this.graph.getNodeById(e));let a=e.findInputSlotIndexByType(i,!0);if(a>=0&&a!==null)return h.debug&&console.debug("CONNbyTYPE type "+i+" for "+a),this.connect(t,e,a);if(h.debug&&console.log("type "+i+" not found or not free?"),r.createEventInCase&&i==k.EVENT)return h.debug&&console.debug("connect WILL CREATE THE onTrigger "+i+" to "+e),this.connect(t,e,-1);if(r.generalTypeInCase){let l=e.findInputSlotIndexByType(k.DEFAULT,!0,!0);if(h.debug&&console.debug("connect TO a general type (*, 0), if not found the specific type ",i," to ",e,"RES_SLOT:",l),l>=0)return this.connect(t,e,l)}if(r.firstFreeIfOutputGeneralInCase&&(i==0||i=="*"||i=="")){let l=e.findInputSlotIndexByName(null,!0,[k.EVENT]);if(h.debug&&console.debug("connect TO TheFirstFREE ",i," to ",e,"RES_SLOT:",l),l>=0)return this.connect(t,e,l)}return h.debug&&console.error("no way to connect type: ",i," to targetNODE ",e),null}connectByTypeOutput(t,e,i,n={}){var s={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},r=Object.assign(s,n);if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),a=e.findOutputSlotIndexByType(i,!0),a>=0&&a!==null)return console.debug("CONNbyTYPE OUT! type "+i+" for "+a),e.connect(a,this,t);if(r.generalTypeInCase){var a=e.findOutputSlotIndexByType(0,!0,!0);if(a>=0)return e.connect(a,this,t)}if(r.createEventInCase&&i==k.EVENT&&h.do_add_triggers_slots){var a=e.addOnExecutedOutput();return e.connect(a,this,t)}if(r.firstFreeIfInputGeneralInCase&&(i==0||i=="*"||i=="")){let l=e.findOutputSlotIndexByName(null,!0,[k.EVENT]);if(l>=0)return e.connect(l,this,t)}return console.error("no way to connect byOUT type: ",i," to sourceNODE ",e),console.error("type OUT! "+i+" not found or not free?"),null}connect(t,e,i){if(i=i||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(typeof t=="string"){if(t=this.findOutputSlotIndexByName(t),t==-1)return h.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return h.debug&&console.log("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return null;if(typeof i=="string"){if(i=e.findInputSlotIndexByName(i),i==-1)return h.debug&&console.log("Connect: Error, no slot of name "+i),null}else if(i===k.EVENT)if(h.do_add_triggers_slots)e.changeMode(j.ON_TRIGGER),i=e.findInputSlotIndexByName("onTrigger");else return null;else if(!e.inputs||i>=e.inputs.length)return h.debug&&console.log("Connect: Error, slot number not found"),null;var n=!1,s=e.inputs[i],r=null,a=this.outputs[t];if(!this.outputs[t])return null;if(e.onBeforeConnectInput&&(i=e.onBeforeConnectInput(i)),i===-1||i===null||!h.isValidConnection(a.type,s.type))return this.setDirtyCanvas(!1,!0),n&&this.graph.connectionChange(this,r),null;if(h.debug&&console.debug("valid connection",a.type,s.type),e.onConnectInput&&e.onConnectInput(i,a.type,a,this,t)===!1||this.onConnectOutput&&this.onConnectOutput(t,s.type,s,e,i)===!1)return null;if(e.inputs[i]&&e.inputs[i].link!=null&&(this.graph.beforeChange(),e.disconnectInput(i,{doProcessChange:!1}),n=!0),a.links!==null&&a.links.length)switch(a.type){case k.EVENT:h.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(t,null,{doProcessChange:!1}),n=!0);break}return r=new J(++this.graph.last_link_id,s.type||a.type,this.id,t,e.id,i),this.graph.links[r.id]=r,a.links==null&&(a.links=[]),a.links.push(r.id),e.inputs[i].link=r.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(U.OUTPUT,t,!0,r,a),e.onConnectionsChange&&e.onConnectionsChange(U.INPUT,i,!0,r,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(U.INPUT,e,i,this,t),this.graph.onNodeConnectionChange(U.OUTPUT,this,t,e,i)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,r),r}disconnectOutput(t,e,i){if(typeof t=="string"){if(t=this.findOutputSlotIndexByName(t),t==-1)return h.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return h.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[t];if(!n||!n.links||n.links.length==0)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var s=0,r=n.links.length;s<r;s++){var a=n.links[s],l=this.graph.links[a];if(l.target_id==e.id){n.links.splice(s,1);var o=e.inputs[l.target_slot];o.link=null,delete this.graph.links[a],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(U.INPUT,l.target_slot,!1,l,o),this.onConnectionsChange&&this.onConnectionsChange(U.OUTPUT,t,!1,l,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(U.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(U.OUTPUT,this,t),this.graph.onNodeConnectionChange(U.INPUT,e,l.target_slot));break}}}else{for(var s=0,r=n.links.length;s<r;s++){var a=n.links[s],l=this.graph.links[a];if(l){var e=this.graph.getNodeById(l.target_id),o=null;this.graph&&this.graph._version++,e&&(o=e.inputs[l.target_slot],o.link=null,e.onConnectionsChange&&e.onConnectionsChange(U.INPUT,l.target_slot,!1,l,o),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(U.INPUT,e,l.target_slot)),delete this.graph.links[a],this.onConnectionsChange&&this.onConnectionsChange(U.OUTPUT,t,!1,l,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(U.OUTPUT,this,t),this.graph.onNodeConnectionChange(U.INPUT,e,l.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(t,e={}){if(typeof t=="string"){if(t=this.findInputSlotIndexByName(t),t==-1)return h.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return h.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.inputs[t];if(!i)return!1;var n=this.inputs[t].link;if(n!=null){this.inputs[t].link=null;var s=this.graph.links[n];if(s){var r=this.graph.getNodeById(s.origin_id);if(!r)return!1;var a=r.outputs[s.origin_slot];if(!a||!a.links||a.links.length==0)return!1;for(var l=0,o=a.links.length;l<o;l++)if(a.links[l]==n){a.links.splice(l,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(U.INPUT,t,!1,s,i),r.onConnectionsChange&&r.onConnectionsChange(U.OUTPUT,l,!1,s,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(U.OUTPUT,r,l),this.graph.onNodeConnectionChange(U.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(t,e,i=[0,0]){var n=0;t&&this.inputs&&(n=this.inputs.length),!t&&this.outputs&&(n=this.outputs.length);var s=h.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){var r=this._collapsed_width||h.NODE_COLLAPSED_WIDTH;return this.horizontal?(i[0]=this.pos[0]+r*.5,t?i[1]=this.pos[1]-h.NODE_TITLE_HEIGHT:i[1]=this.pos[1]):(t?i[0]=this.pos[0]:i[0]=this.pos[0]+r,i[1]=this.pos[1]-h.NODE_TITLE_HEIGHT*.5),i}return t&&e==-1?(i[0]=this.pos[0]+h.NODE_TITLE_HEIGHT*.5,i[1]=this.pos[1]+h.NODE_TITLE_HEIGHT*.5,i):t&&n>e&&this.inputs[e].pos?(i[0]=this.pos[0]+this.inputs[e].pos[0],i[1]=this.pos[1]+this.inputs[e].pos[1],i):!t&&n>e&&this.outputs[e].pos?(i[0]=this.pos[0]+this.outputs[e].pos[0],i[1]=this.pos[1]+this.outputs[e].pos[1],i):this.horizontal?(i[0]=this.pos[0]+(e+.5)*(this.size[0]/n),t?i[1]=this.pos[1]-h.NODE_TITLE_HEIGHT:i[1]=this.pos[1]+this.size[1],i):(t?i[0]=this.pos[0]+s:i[0]=this.pos[0]+this.size[0]+1-s,i[1]=this.pos[1]+(e+.7)*h.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),i)}alignToGrid(){this.pos[0]=h.CANVAS_GRID_SIZE*Math.round(this.pos[0]/h.CANVAS_GRID_SIZE),this.pos[1]=h.CANVAS_GRID_SIZE*Math.round(this.pos[1]/h.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>ye.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)}setDirtyCanvas(t,e=!1){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])}loadImage(t){var e=new Image;e.src=h.node_images_path+t;var i=this;return e.onload=function(){i.setDirtyCanvas(!0)},e}captureInput(t){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var e=this.graph.list_of_graphcanvas,i=0;i<e.length;++i){var n=e[i];!t&&n.node_capturing_input!=this||(n.node_capturing_input=t?this:null)}}collapse(t=!1){this.graph._version++,!(this.collapsable===!1&&!t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(t){this.graph._version++,t===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=t}localToScreen(t,e,i){return[(t+this.pos[0])*i.ds.scale+i.ds.offset[0],(e+this.pos[1])*i.ds.scale+i.ds.offset[1]]}getOptionalSlots(){return fe(this,"optionalSlots")}};let te=ye;te.registerCategory="",te.MAX_CONSOLE=100;const A=class{static registerNodeType(t){A.debug&&console.log("Node registered: "+t.type);const e=t.name,i=t.type;if(!i)throw"Config has no type: "+t;console.debug(e,i);const n=i.lastIndexOf("/");t.category=i.substring(0,n),t.title||(t.title=e);const s=A.registered_node_types[i];if(s&&console.warn("replacing node type: "+i),t.supported_extensions)for(let r in t.supported_extensions){const a=t.supported_extensions[r];a&&a.constructor===String&&(A.node_types_by_file_extension[a.toLowerCase()]=t)}t.class.__LITEGRAPH_TYPE__=i,A.registered_node_types[i]=t,t.class.name&&(A.Nodes[e]=t),A.onNodeTypeRegistered&&A.onNodeTypeRegistered(i,t),s&&A.onNodeTypeReplaced&&A.onNodeTypeReplaced(i,t,s)}static unregisterNodeType(t){let e;if(typeof t=="string"?e=A.registered_node_types[t]:e=t,!e)throw"node type not found: "+t;delete A.registered_node_types[e.type],e.constructor.name&&delete A.Nodes[e.constructor.name]}static registerNodeAndSlotType(t,e,i=!1){let n;if(typeof t=="string"?n=A.registered_node_types[t]:"type"in t?n=A.registered_node_types[t.type]:n=t,!n)throw"Node not registered!"+t;var s=n.class.__litegraph_type__;if(typeof e=="string")var r=e.split(",");else if(e==k.EVENT||e==k.ACTION)var r=["_event_"];else var r=["*"];for(var a=0;a<r.length;++a){var l=r[a];l===""&&(l="*");var o=i?"registered_slot_out_types":"registered_slot_in_types";typeof this[o][l]>"u"&&(this[o][l]={nodes:[]}),this[o][l].nodes.push(s),i?A.slot_types_out.includes(l.toLowerCase())||(A.slot_types_out.push(l.toLowerCase()),A.slot_types_out.sort()):A.slot_types_in.includes(l.toLowerCase())||(A.slot_types_in.push(l.toLowerCase()),A.slot_types_in.sort())}}static clearRegisteredTypes(){A.registered_node_types={},A.node_types_by_file_extension={},A.Nodes={},A.searchbox_extras={}}static createNode(t,e,i){let n=null,s;if(typeof t=="string")s=t;else if(s=t.__LITEGRAPH_TYPE__,!s)throw console.error(t),"Node was not registered yet!";if(n=A.registered_node_types[s],!n)return console.warn('GraphNode type "'+t+'" not registered.'),null;e=e||n.title||s;var r=null;if(A.catch_exceptions)try{r=new n.class(e)}catch(u){return console.error(u),null}else r=new n.class(e);if(r.class=n.class,r.type=s,!r.title&&e&&(r.title=e),r.properties||(r.properties={}),r.properties_info||(r.properties_info=[]),r.flags||(r.flags={}),r.size||(r.size=r.computeSize()),r.pos||(r.pos=[A.DEFAULT_POSITION[0],A.DEFAULT_POSITION[1]]),r.mode||(r.mode=j.ALWAYS),i)for(var a in i)r[a]=i[a];const l=me(n.class,"propertyLayout");if(l){console.log("Found property layout!",l);for(const u of l){const{name:p,defaultValue:d,type:c,options:_}=u;r.addProperty(p,d,c,_)}}const o=me(n.class,"slotLayout");if(o&&(console.log("Found slot layout!",o),o.inputs)){for(const u of o.inputs){const{name:p,type:d,options:c}=u;r.addInput(p,d,c)}for(const u of o.outputs){const{name:p,type:d,options:c}=u;r.addOutput(p,d,c)}}return r.onNodeCreated&&r.onNodeCreated(),r}static getNodeType(t){return A.registered_node_types[t]}static getNodeTypesInCategory(t,e){var i=[];for(var n in A.registered_node_types){var s=A.registered_node_types[n];s.filter==e&&(t==""?s.category==null&&i.push(s):s.category==t&&i.push(s))}return A.auto_sort_node_types&&i.sort(function(r,a){return r.title.localeCompare(a.title)}),i}static getNodeTypesCategories(t){var e={"":1};for(var i in A.registered_node_types){var n=A.registered_node_types[i];if(n.category&&!n.skip_list){if(n.filter!=t)continue;e[n.category]=1}}var s=[];for(var i in e)s.push(i);return A.auto_sort_node_types?s.sort():s}static reloadNodes(t){for(var e=document.getElementsByTagName("script"),i=[],n=0;n<e.length;n++)i.push(e[n]);var s=document.getElementsByTagName("head")[0];t=document.location.href+t;for(var n=0;n<i.length;n++){var r=i[n].src;if(!(!r||r.substr(0,t.length)!=t))try{A.debug&&console.log("Reloading: "+r);var a=document.createElement("script");a.type="text/javascript",a.src=r,s.appendChild(a),s.removeChild(i[n])}catch(o){if(A.throw_errors)throw o;A.debug&&console.log("Error while reloading "+r)}}A.debug&&console.log("Nodes reloaded")}static cloneObject(t,e){if(t==null)return null;var i=JSON.parse(JSON.stringify(t));if(!e)return i;for(var n in i)e[n]=i[n];return e}static isValidConnection(t,e){if((t==""||t==="*")&&(t=0),(e==""||e==="*")&&(e=0),!t||!e||t==e||t==k.EVENT&&e==k.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),t.indexOf(",")==-1&&e.indexOf(",")==-1)return t==e;for(var i=t.split(","),n=e.split(","),s=0;s<i.length;++s)for(var r=0;r<n.length;++r)if(this.isValidConnection(i[s],n[r]))return!0;return!1}static getTime(){return Date.now()}static compareObjects(t,e){for(var i in t)if(t[i]!=e[i])return!1;return!0}static distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}static colorToString(t){return"rgba("+Math.round(t[0]*255).toFixed()+","+Math.round(t[1]*255).toFixed()+","+Math.round(t[2]*255).toFixed()+","+(t.length==4?t[3].toFixed(2):"1.0")+")"}static isInsideRectangle(t,e,i,n,s,r){return i<t&&i+s>t&&n<e&&n+r>e}static growBounding(t,e,i){return e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),i<t[1]?t[1]=i:i>t[3]&&(t[3]=i),t}static isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}static overlapBounding(t,e){var i=t[0]+t[2],n=t[1]+t[3],s=e[0]+e[2],r=e[1]+e[3];return!(t[0]>s||t[1]>r||i<e[0]||n<e[1])}static hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();var e="0123456789ABCDEF";let i;for(var n=0,s,r,a=0;a<6;a+=2)s=e.indexOf(t.charAt(a)),r=e.indexOf(t.charAt(a+1)),i[n]=s*16+r,n++;return i}static num2hex(t){for(var e="0123456789ABCDEF",i="#",n,s,r=0;r<3;r++)n=t[r]/16,s=t[r]%16,i+=e.charAt(n)+e.charAt(s);return i}static pointerListenerAdd(t,e,i,n=!1){if(!(!t||!t.addEventListener||!e||typeof i!="function")){var s=A.pointerevents_method,r=e;if(s=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+r+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),r){case"down":{s="touch",r="start";break}case"move":{s="touch";break}case"up":{s="touch",r="end";break}case"cancel":{s="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn("PointerEvent not available in this browser ? The event "+r+" would not be called")}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(s+r,i,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(s!="mouse")return t.addEventListener(s+r,i,n);default:return t.addEventListener(r,i,n)}}}static pointerListenerRemove(t,e,i,n=!1){if(!(!t||!t.removeEventListener||!e||typeof i!="function"))switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":(A.pointerevents_method=="pointer"||A.pointerevents_method=="mouse")&&t.removeEventListener(A.pointerevents_method+e,i,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(A.pointerevents_method=="pointer")return t.removeEventListener(A.pointerevents_method+e,i,n);default:return t.removeEventListener(e,i,n)}}};let h=A;h.VERSION=10,h.CANVAS_GRID_SIZE=10,h.NODE_TITLE_HEIGHT=20,h.NODE_TITLE_TEXT_Y=15,h.NODE_SLOT_HEIGHT=20,h.NODE_WIDGET_HEIGHT=20,h.NODE_WIDTH=140,h.NODE_MIN_WIDTH=50,h.NODE_COLLAPSED_RADIUS=10,h.NODE_COLLAPSED_WIDTH=80,h.NODE_TITLE_COLOR="#999",h.NODE_SELECTED_TITLE_COLOR="#FFF",h.NODE_TEXT_SIZE=14,h.NODE_TEXT_COLOR="#AAA",h.NODE_SUBTEXT_SIZE=12,h.NODE_DEFAULT_COLOR="#333",h.NODE_DEFAULT_BGCOLOR="#353535",h.NODE_DEFAULT_BOXCOLOR="#666",h.NODE_DEFAULT_SHAPE="box",h.NODE_BOX_OUTLINE_COLOR="#FFF",h.DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)",h.DEFAULT_GROUP_FONT_SIZE=24,h.WIDGET_BGCOLOR="#222",h.WIDGET_OUTLINE_COLOR="#666",h.WIDGET_TEXT_COLOR="#DDD",h.WIDGET_SECONDARY_TEXT_COLOR="#999",h.LINK_COLOR="#9A9",h.EVENT_LINK_COLOR="#A86",h.ACTION_LINK_COLOR="#86A",h.CONNECTING_LINK_COLOR="#AFA",h.MAX_NUMBER_OF_NODES=1e3,h.DEFAULT_POSITION=[100,100],h.proxy=null,h.node_images_path="",h.debug=!1,h.catch_exceptions=!0,h.throw_errors=!0,h.allow_scripts=!1,h.registered_node_types={},h.node_types_by_file_extension={},h.Nodes={},h.Globals={},h.searchbox_extras={},h.auto_sort_node_types=!1,h.node_box_coloured_when_on=!1,h.node_box_coloured_by_mode=!1,h.dialog_close_on_mouse_leave=!0,h.dialog_close_on_mouse_leave_delay=500,h.shift_click_do_break_link_from=!1,h.click_do_break_link_to=!1,h.search_hide_on_mouse_leave=!0,h.search_filter_enabled=!1,h.search_show_all_on_open=!0,h.auto_load_slot_types=!1,h.registered_slot_in_types={},h.registered_slot_out_types={},h.slot_types_in=[],h.slot_types_out=[],h.slot_types_default_in={},h.slot_types_default_out={},h.alt_drag_do_clone_nodes=!1,h.do_add_triggers_slots=!1,h.allow_multi_output_for_events=!0,h.middle_click_slot_add_default_node=!1,h.release_link_on_empty_shows_menu=!1,h.ignore_all_widget_events=!1,h.pointerevents_method="mouse";var Z=(t=>(t[t.SEPARATOR=0]="SEPARATOR",t))(Z||{});class Y{static trigger(e,i,n,s){var r=document.createEvent("CustomEvent");return r.initCustomEvent(i,!0,!0,n),r.target=s,e.dispatchEvent&&e.dispatchEvent(r),r}static isCursorOverElement(e,i){var n=e.clientX,s=e.clientY,r=i.getBoundingClientRect();return r?s>r.top&&s<r.top+r.height&&n>r.left&&n<r.left+r.width:!1}static closeAllContextMenus(e){e=e||window;var i=e.document.querySelectorAll(".litecontextmenu");if(i.length){var n=Array.from(i);for(const s of n)s.close()}}constructor(e,i={},n){this.options=i;var s=this;i.parentMenu&&(i.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=null):(this.parentMenu=i.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var r=null;i.event&&(r=i.event.constructor.name),r!=="MouseEvent"&&r!=="CustomEvent"&&r!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+r+")"),i.event=null);var a=document.createElement("div");a.className="litegraph litecontextmenu litemenubar-panel",i.className&&(a.className+=" "+i.className),a.style.pointerEvents="none",setTimeout(function(){a.style.pointerEvents="auto"},100),h.pointerListenerAdd(a,"up",function(g){return g.preventDefault(),!0},!0),a.addEventListener("contextmenu",function(g){return g.button!=2||g.preventDefault(),!1},!0),a.close=()=>{a.parentNode.removeChild(a)},h.pointerListenerAdd(a,"down",function(g){if(g.button==2)return s.close(),g.preventDefault(),!0},!0);function l(g){var m=parseInt(a.style.top);return a.style.top=(m+g.deltaY*i.scroll_speed).toFixed()+"px",g.preventDefault(),!0}if(i.scroll_speed||(i.scroll_speed=.1),a.addEventListener("wheel",l,!0),a.addEventListener("mousewheel",l,!0),this.root=a,i.title){var o=document.createElement("div");o.className="litemenu-title",o.innerHTML=i.title,a.appendChild(o)}this.values=[];for(let g=0;g<e.length;g++){let m=e[g],y="";m===0?y="":typeof m=="string"?y=m:y=m.content,this.addItem(y,m,i)}h.pointerListenerAdd(a,"enter",function(g){a.closing_timer&&clearTimeout(a.closing_timer)});var u=document;i.event&&i.event.target instanceof Node&&(u=i.event.target.ownerDocument),u||(u=document),u.fullscreenElement?u.fullscreenElement.appendChild(a):u.body.appendChild(a);var p=i.left||0,d=i.top||0;if(i.event){if(p=i.event.clientX-10,d=i.event.clientY-10,i.title&&(d-=20),i.parentMenu){var c=i.parentMenu.root.getBoundingClientRect();p=c.left+c.width}var _=document.body.getBoundingClientRect(),f=a.getBoundingClientRect();_.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),_.width&&p>_.width-f.width-10&&(p=_.width-f.width-10),_.height&&d>_.height-f.height-10&&(d=_.height-f.height-10)}a.style.left=p+"px",a.style.top=d+"px",i.scale&&(a.style.transform="scale("+i.scale+")")}addItem(e,i,n={}){var s=this,r=document.createElement("div");r.className="litemenu-entry submenu";var a=!1;typeof i=="string"&&(i={content:i}),i===0?r.classList.add("separator"):(r.innerHTML=i.title?i.title:e,i.disabled&&(a=!0,r.classList.add("disabled")),(i.submenu||i.has_submenu)&&r.classList.add("has_submenu"),typeof i=="function"?r.dataset.value=e:r.dataset.value=""+this.values.length,i.className&&(r.className+=" "+i.className)),this.values.push(i),this.root.appendChild(r),a||r.addEventListener("click",u),n.autoopen&&h.pointerListenerAdd(r,"enter",o);let l=this;function o(p){var d=this.value;!d||!d.has_submenu||u.call(this,p)}function u(p){let d=parseInt(this.dataset.value);var c=l.values[d];h.debug&&console.debug("ContextMenu inner_onclick",d,c);var _=!0;if(s.current_submenu&&s.current_submenu.close(p),n.callback){var f=n.callback.call(this,c,n,p,s,n.node);f===!0&&(_=!1)}if(c&&typeof c=="object"){if(c.callback&&!n.ignore_item_callbacks&&c.disabled!==!0){var f=c.callback.call(this,c,n,p,s,n.extra);f===!0&&(_=!1)}if(c.submenu){if(!c.submenu.options)throw"ContextMenu submenu needs options";new Y(c.submenu.options,{callback:c.submenu.callback,event:p,parentMenu:s,ignore_item_callbacks:c.submenu.ignore_item_callbacks,title:c.submenu.title,extra:c.submenu.extra,autoopen:n.autoopen}),_=!1}}_&&!s.lock&&s.close()}return r}close(e,i){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!i&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,e===void 0?this.parentMenu.close():e&&!Y.isCursorOverElement(e,this.parentMenu.root)&&Y.trigger(this.parentMenu.root,h.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}}class Ce{constructor(e,i=!1){this.offset=[0,0],this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array([0,0,0,0]),this.viewport=null,this.dragging=!1,this._binded_mouse_callback=null,e&&(this.element=e,i||this.bindEvents(e))}bindEvents(e){this.last_mouse=[0,0],this._binded_mouse_callback=this.onMouse.bind(this),h.pointerListenerAdd(e,"down",this._binded_mouse_callback),h.pointerListenerAdd(e,"move",this._binded_mouse_callback),h.pointerListenerAdd(e,"up",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)}computeVisibleArea(e){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var i=this.element.width,n=this.element.height,s=-this.offset[0],r=-this.offset[1];e&&(s+=e[0]/this.scale,r+=e[1]/this.scale,i=e[2],n=e[3]);var a=s+i/this.scale,l=r+n/this.scale;this.visible_area[0]=s,this.visible_area[1]=r,this.visible_area[2]=a-s,this.visible_area[3]=l-r}onMouse(e){if(!this.enabled)return;var i=this.element,n=i.getBoundingClientRect();let s=e;var r=s.clientX-n.left,a=s.clientY-n.top;s.canvasX=r,s.canvasX=a,s.dragging=this.dragging;var l=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&a>=this.viewport[1]&&a<this.viewport[1]+this.viewport[3];if(s.type==h.pointerevents_method+"down"&&l)this.dragging=!0,h.pointerListenerRemove(i,"move",this._binded_mouse_callback),h.pointerListenerAdd(document,"move",this._binded_mouse_callback),h.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(s.type==h.pointerevents_method+"move"){var o=r-this.last_mouse[0],u=a-this.last_mouse[1];this.dragging&&this.mouseDrag(o,u)}else s.type==h.pointerevents_method+"up"?(this.dragging=!1,h.pointerListenerRemove(document,"move",this._binded_mouse_callback),h.pointerListenerRemove(document,"up",this._binded_mouse_callback),h.pointerListenerAdd(i,"move",this._binded_mouse_callback)):l&&(s.type=="mousewheel"||s.type=="wheel"||s.type=="DOMMouseScroll")&&(s.eventType="mousewheel",s.type=="wheel"?s.wheel=-s.deltaY:s.wheel=s.wheelDeltaY!=null?s.wheelDeltaY:s.detail*-60,s.delta=s.wheelDelta?s.wheelDelta/40:s.deltaY?-s.deltaY/3:0,this.changeDeltaScale(1+s.delta*.05));if(this.last_mouse[0]=r,this.last_mouse[1]=a,l)return s.preventDefault(),s.stopPropagation(),!1}toCanvasContext(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]}convertCanvasToOffset(e,i=[0,0]){return i[0]=e[0]/this.scale-this.offset[0],i[1]=e[1]/this.scale-this.offset[1],i}mouseDrag(e,i){this.offset[0]+=e/this.scale,this.offset[1]+=i/this.scale,this.onredraw&&this.onredraw(this)}changeScale(e,i){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!=this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){i=i||[n.width*.5,n.height*.5];var s=this.convertCanvasToOffset(i);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var r=this.convertCanvasToOffset(i),a=[r[0]-s[0],r[1]-s[1]];this.offset[0]+=a[0],this.offset[1]+=a[1],this.onredraw&&this.onredraw(this)}}}changeDeltaScale(e,i){this.changeScale(this.scale*e,i)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}class oe{processMouseDown(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;let i=e;this.adjustMouseEvent(i);var n=this.getCanvasWindow();n.document,T.active_canvas=this;var s=this,r=i.clientX,a=i.clientY;this.ds.viewport=this.viewport;var l=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&a>=this.viewport[1]&&a<this.viewport[1]+this.viewport[3];if(this.skip_events||(h.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),h.pointerListenerAdd(n.document,"move",this._mousemove_callback,!0),h.pointerListenerAdd(n.document,"up",this._mouseup_callback,!0)),!!l){var o=this.graph.getNodeOnPos(i.canvasX,i.canvasY,this.visible_nodes,5),u=!1,p=h.getTime(),d=!(i instanceof PointerEvent)||!i.isPrimary,c=p-this.last_mouseclick<300&&d;if(this.mouse[0]=i.clientX,this.mouse[1]=i.clientY,this.graph_mouse[0]=i.canvasX,this.graph_mouse[1]=i.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&d?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),Y.closeAllContextMenus(n),!(this.onMouse&&this.onMouse(i)==!0)){if(i.which==1&&!this.pointer_is_double){if(i.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=i.canvasX,this.dragging_rectangle[1]=i.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,u=!0),h.alt_drag_do_clone_nodes&&i.altKey&&o&&this.allow_interaction&&!u&&!this.read_only){let $=o.clone();$&&($.pos[0]+=5,$.pos[1]+=5,this.graph.add($,{doCalcSize:!1}),o=$,u=!0,b||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,i)))}var _=!1;if(o&&this.allow_interaction&&!u&&!this.read_only){if(!this.live_mode&&!o.flags.pinned&&this.bringToFront(o),!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!u&&o.resizable!==!1&&h.isInsideRectangle(i.canvasX,i.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",u=!0;else{if(o.outputs)for(var f=0,g=o.outputs.length;f<g;++f){var m=o.outputs[f],y=o.getConnectionPos(!1,f);if(h.isInsideRectangle(i.canvasX,i.canvasY,y[0]-15,y[1]-10,30,20)){this.connecting_node=o,this.connecting_output=m,this.connecting_output.slot_index=f,this.connecting_pos=o.getConnectionPos(!1,f),this.connecting_slot=f,h.shift_click_do_break_link_from&&i.shiftKey&&o.disconnectOutput(f),c?o.onOutputDblClick&&o.onOutputDblClick(f,i):o.onOutputClick&&o.onOutputClick(f,i),u=!0;break}}if(o.inputs)for(var f=0,g=o.inputs.length;f<g;++f){var E=o.inputs[f],y=o.getConnectionPos(!0,f);if(h.isInsideRectangle(i.canvasX,i.canvasY,y[0]-15,y[1]-10,30,20)){if(c?o.onInputDblClick&&o.onInputDblClick(f,i):o.onInputClick&&o.onInputClick(f,i),E.link!==null){var v=this.graph.links[E.link];h.click_do_break_link_to&&(o.disconnectInput(f),this.dirty_bgcanvas=!0,u=!0),(this.allow_reconnect_links||i.shiftKey)&&(h.click_do_break_link_to||o.disconnectInput(f),this.connecting_node=this.graph._nodes_by_id[v.origin_id],this.connecting_slot=v.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,u=!0)}u||(this.connecting_node=o,this.connecting_input=E,this.connecting_input.slot_index=f,this.connecting_pos=o.getConnectionPos(!0,f),this.connecting_slot=f,this.dirty_bgcanvas=!0,u=!0)}}}if(!u){var b=!1,C=[i.canvasX-o.pos[0],i.canvasY-o.pos[1]],O=this.processNodeWidgets(o,this.graph_mouse,i);if(O&&(b=!0,this.node_widget=[o,O]),c&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(i,C,this),this.processNodeDblClicked(o),b=!0),o.onMouseDown&&o.onMouseDown(i,C,this))b=!0;else{if(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&C[0]>o.size[0]-h.NODE_TITLE_HEIGHT&&C[1]<0){var s=this;setTimeout(function(){s.openSubgraph(o.subgraph)},10)}this.live_mode&&(_=!0,b=!0)}b||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,i)),this.dirty_canvas=!0}}else if(!u){if(!this.read_only)for(var f=0;f<this.visible_links.length;++f){var G=this.visible_links[f],B=G._pos;if(!(!B||i.canvasX<B[0]-4||i.canvasX>B[0]+4||i.canvasY<B[1]-4||i.canvasY>B[1]+4)){this.showLinkMenu(G,i),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(i.canvasX,i.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only){i.ctrlKey&&(this.dragging_rectangle=null);var z=h.distance([i.canvasX,i.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);z*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}c&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(i),i.preventDefault(),i.stopPropagation()),_=!0}!u&&_&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(i.which==2){if(h.middle_click_slot_add_default_node&&o&&this.allow_interaction&&!u&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var F=null,R=null,w=null;if(o.outputs)for(var f=0,g=o.outputs.length;f<g;++f){var m=o.outputs[f],y=o.getConnectionPos(!1,f);if(h.isInsideRectangle(i.canvasX,i.canvasY,y[0]-15,y[1]-10,30,20)){F=m,R=f,w=!0;break}}if(o.inputs)for(var f=0,g=o.inputs.length;f<g;++f){var E=o.inputs[f],y=o.getConnectionPos(!0,f);if(h.isInsideRectangle(i.canvasX,i.canvasY,y[0]-15,y[1]-10,30,20)){F=E,R=f,w=!1;break}}if(F&&R!==!1){var L=.5-(R+1)/(w?o.outputs.length:o.inputs.length),M=o.getBounding(),W=[w?M[0]+M[2]:M[0],i.canvasY-80];this.createDefaultNodeForSlot("AUTO",{nodeFrom:w?o:null,slotFrom:w?R:null,nodeTo:w?null:o,slotTo:w?null:R,position:W,posAdd:[w?30:-30,-L*130],posSizeFix:[w?0:-1,0]})}}}else(i.which==3||this.pointer_is_double)&&this.allow_interaction&&!u&&!this.read_only&&(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||i.shiftKey||i.ctrlKey||i.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,i));if(this.selected_group_moving=!1,this.selected_group&&!this.selected_group_resizing){var x=this.selected_group.fontSize||h.DEFAULT_GROUP_FONT_SIZE,H=x*1.4;h.isInsideRectangle(i.canvasX,i.canvasY,this.selected_group.pos[0],this.selected_group.pos[1],this.selected_group.size[0],H)&&(this.selected_group_moving=!0)}return this.last_mouse[0]=i.clientX,this.last_mouse[1]=i.clientY,this.last_mouseclick=h.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!n.document.activeElement||n.document.activeElement.nodeName.toLowerCase()!="input"&&n.document.activeElement.nodeName.toLowerCase()!="textarea")&&i.preventDefault(),i.stopPropagation(),this.onMouseDown&&this.onMouseDown(i),!1}}}processMouseMove(e){let i=e;if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;T.active_canvas=this,this.adjustMouseEvent(i);let n=[i.clientX,i.clientY];this.mouse[0]=n[0],this.mouse[1]=n[1];let s=[n[0]-this.last_mouse[0],n[1]-this.last_mouse[1]];if(this.last_mouse=n,this.graph_mouse[0]=i.canvasX,this.graph_mouse[1]=i.canvasY,this.block_click)return i.preventDefault(),!1;i.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,i,this.node_widget[1]),this.dirty_canvas=!0);const r=this.selected_group;if(this.selected_group&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=null),this.dragging_rectangle)this.dragging_rectangle[2]=i.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=i.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[i.canvasX-this.selected_group.pos[0],i.canvasY-this.selected_group.pos[1]];else{var a=s[0]/this.ds.scale,l=s[1]/this.ds.scale;this.selected_group.move(a,l,i.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=s[0]/this.ds.scale,this.ds.offset[1]+=s[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o=this.graph.getNodeOnPos(i.canvasX,i.canvasY,this.visible_nodes),u=0,p=this.graph._nodes.length;u<p;++u){let b=this.graph._nodes[u];b.mouseOver&&o!=b&&(b.mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(i,[i.canvasX-this.node_over.pos[0],i.canvasY-this.node_over.pos[1]],this),this.node_over=null,this.dirty_canvas=!0)}if(o){if(o.redraw_on_mouse&&(this.dirty_canvas=!0),o.mouseOver||(o.mouseOver=!0,this.node_over=o,this.dirty_canvas=!0,o.onMouseEnter&&o.onMouseEnter(i,[i.canvasX-o.pos[0],i.canvasY-o.pos[1]],this)),o.onMouseMove&&o.onMouseMove(i,[i.canvasX-o.pos[0],i.canvasY-o.pos[1]],this),this.connecting_node){if(this.connecting_output){var d=this._highlight_input||[0,0];if(!this.isOverNodeBox(o,i.canvasX,i.canvasY)){var c=this.isOverNodeInput(o,i.canvasX,i.canvasY,d);if(c!=-1&&o.inputs[c]){var _=o.inputs[c].type;h.isValidConnection(this.connecting_output.type,_)&&(this._highlight_input=d,this._highlight_input_slot=o.inputs[c])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var d=this._highlight_output||[0,0];if(!this.isOverNodeBox(o,i.canvasX,i.canvasY)){var c=this.isOverNodeOutput(o,i.canvasX,i.canvasY,d);if(c!=-1&&o.outputs[c]){var _=o.outputs[c].type;h.isValidConnection(this.connecting_input.type,_)&&(this._highlight_output=d)}else this._highlight_output=null}}}this.canvas&&(h.isInsideRectangle(i.canvasX,i.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var f=null,u=0;u<this.visible_links.length;++u){var g=this.visible_links[u],m=g._pos;if(!(!m||i.canvasX<m[0]-4||i.canvasX>m[0]+4||i.canvasY<m[1]-4||i.canvasY>m[1]+4)){f=g;break}}f!=this.over_link_center&&(this.over_link_center=f,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=o&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(i,[i.canvasX-this.node_capturing_input.pos[0],i.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(const b in this.selected_nodes){var y=this.selected_nodes[b];y.pos[0]+=s[0]/this.ds.scale,y.pos[1]+=s[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var E=[i.canvasX-this.resizing_node.pos[0],i.canvasY-this.resizing_node.pos[1]],v=this.resizing_node.computeSize();E[0]=Math.max(v[0],E[0]),E[1]=Math.max(v[1],E[1]),this.resizing_node.setSize(E),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return r&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=r),i.preventDefault(),!1}processMouseUp(e){let i=e;var n=!(i instanceof PointerEvent)||!i.isPrimary;if(!n)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var s=this.getCanvasWindow(),r=s.document;T.active_canvas=this,this.skip_events||(h.pointerListenerRemove(r,"move",this._mousemove_callback,!0),h.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),h.pointerListenerRemove(r,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(i);var a=h.getTime();if(i.click_time=a-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),i.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,i),this.node_widget=null,this.selected_group){var l=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(l,o,i.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var u=this.graph.getNodeOnPos(i.canvasX,i.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var p=this.graph._nodes,d=new Float32Array(4),c=Math.abs(this.dragging_rectangle[2]),_=Math.abs(this.dragging_rectangle[3]),f=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-c:this.dragging_rectangle[0],g=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-_:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=f,this.dragging_rectangle[1]=g,this.dragging_rectangle[2]=c,this.dragging_rectangle[3]=_,!u||c>10&&_>10){for(var m=[],y=0;y<p.length;++y){var E=p[y];E.getBounding(d),h.overlapBounding(this.dragging_rectangle,d)&&m.push(E)}m.length&&this.selectNodes(m,i.shiftKey)}else this.selectNodes([u],i.shiftKey||i.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var v=this.connecting_output||this.connecting_input,b=v.type;if(u){if(this.connecting_output){var C=this.isOverNodeInput(u,i.canvasX,i.canvasY);C!=-1?this.connecting_node.connect(this.connecting_slot,u,C):this.connecting_node.connectByTypeInput(this.connecting_slot,u,b)}else if(this.connecting_input){var C=this.isOverNodeOutput(u,i.canvasX,i.canvasY);C!=-1?u.connect(C,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,u,b)}}else h.release_link_on_empty_shows_menu&&(i.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(i,{node_from:this.connecting_node,slotFrom:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(i,{node_to:this.connecting_node,slotFrom:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:i}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:i}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var u=this.node_dragged;u&&i.click_time<300&&h.isInsideRectangle(i.canvasX,i.canvasY,u.pos[0],u.pos[1]-h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT)&&u.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var u=this.graph.getNodeOnPos(i.canvasX,i.canvasY,this.visible_nodes);!u&&i.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(i,[i.canvasX-this.node_over.pos[0],i.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(i,[i.canvasX-this.node_capturing_input.pos[0],i.canvasY-this.node_capturing_input.pos[1]],this)}}else i.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):i.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return n&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),i.stopPropagation(),i.preventDefault(),!1}}processMouseWheel(e){let i=e;if(!(!this.graph||!this.allow_dragcanvas)){var n=i.wheelDeltaY!=null?i.wheelDeltaY:i.detail*-60;this.adjustMouseEvent(i);var s=i.clientX,r=i.clientY,a=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&r>=this.viewport[1]&&r<this.viewport[1]+this.viewport[3];if(a){var l=this.ds.scale;return n>0?l*=1.1:n<0&&(l*=1/1.1),this.ds.changeScale(l,[i.clientX,i.clientY]),this.graph.change(),i.preventDefault(),!1}}}}const ie=class{setZoom(t,e){this.ds.changeScale(t,e),this.maxZoom&&this.ds.scale>this.maxZoom?this.scale=this.maxZoom:this.minZoom&&this.ds.scale<this.minZoom&&(this.scale=this.minZoom)}bringToFront(t){var e=this.graph._nodes.indexOf(t);e!=-1&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))}sendToBack(t){var e=this.graph._nodes.indexOf(t);e!=-1&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))}computeVisibleNodes(t,e=[]){var i=e;i.length=0,t=t||this.graph._nodes;for(var n=0,s=t.length;n<s;++n){var r=t[n];this.live_mode&&!r.onDrawBackground&&!r.onDrawForeground||h.overlapBounding(this.visible_area,r.getBounding(ie.temp))&&i.push(r)}return i}draw(t=!1,e=!1){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var i=h.getTime();this.render_time=(i-this.last_draw_time)*.001,this.last_draw_time=i,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&i-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.canvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas,i=this.viewport||this.dirty_area;if(i&&(t.save(),t.beginPath(),t.rect(i[0],i[1],i[2],i[3]),t.clip()),this.clear_background&&(i?t.clearRect(i[0],i[1],i[2],i[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,i?i[0]:0,i?i[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var n=this.computeVisibleNodes(null,this.visible_nodes),s=0;s<n.length;++s){var r=n[s];t.save(),t.translate(r.pos[0],r.pos[1]),this.drawNode(r,t),t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),this.connecting_pos!=null){t.lineWidth=this.connections_width;var a=null,l=this.connecting_output||this.connecting_input,o=l.type,u=l.dir;u==null&&(this.connecting_output?u=this.connecting_node.horizontal?I.DOWN:I.RIGHT:u=this.connecting_node.horizontal?I.UP:I.LEFT);var p=l.shape;switch(o){case k.EVENT:a=h.EVENT_LINK_COLOR;break;default:a=h.CONNECTING_LINK_COLOR}if(this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,a,u,I.CENTER),t.beginPath(),o===k.EVENT||p===S.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):p===S.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input){t.beginPath();var d=this._highlight_input_slot.shape;d===S.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),t.fill()}this._highlight_output&&(t.beginPath(),d===S.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null,this),this.onDrawForeground&&this.onDrawForeground(t,this.visible_area),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),i&&t.restore()}}drawSubgraphPanel(t){var e=this.graph,i=e._subgraph_node;if(!i){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(e,i,t),this.drawSubgraphPanelRight(e,i,t)}drawSubgraphPanelLeft(t,e,i){var n=e.inputs?e.inputs.length:0,s=200,r=Math.floor(h.NODE_SLOT_HEIGHT*1.6);if(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(10,10,s,(n+1)*r+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left",i.fillText("Graph Inputs",20,34),this.drawButton(s-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var a=50;if(i.font="14px Arial",e.inputs)for(var l=0;l<e.inputs.length;++l){var o=e.inputs[l];if(!o.not_subgraph_input){if(this.drawButton(20,a+2,s-20,r-2)){var u=e.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=h.createNode(u);p?(t.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",o.name),p.setProperty("type",o.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",u)}i.fillStyle="#9C9",i.beginPath(),i.arc(s-16,a+r*.5,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(o.name,30,a+r*.75),i.fillStyle="#777",i.fillText(""+o.type,130,a+r*.75),a+=r}}this.drawButton(20,a+2,s-20,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)}drawSubgraphPanelRight(t,e,i){var n=e.outputs?e.outputs.length:0,s=this.bgcanvas.width,r=200,a=Math.floor(h.NODE_SLOT_HEIGHT*1.6);i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(s-r-10,10,r,(n+1)*a+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left";var l="Graph Outputs",o=i.measureText(l).width;if(i.fillText(l,s-o-20,34),this.drawButton(s-r,20,20,20,"X","#151515")){this.closeSubgraph();return}var u=50;if(i.font="14px Arial",e.outputs)for(var p=0;p<e.outputs.length;++p){var d=e.outputs[p];if(!d.not_subgraph_output){if(this.drawButton(s-r,u+2,r-20,a-2)){var c=e.constructor.output_node_type||"graph/output";this.graph.beforeChange();var _=h.createNode(c);_?(t.add(_),this.block_click=!1,this.last_click_position=null,this.selectNodes([_]),this.node_dragged=_,this.dragging_canvas=!1,_.setProperty("name",d.name),_.setProperty("type",d.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",c)}i.fillStyle="#9C9",i.beginPath(),i.arc(s-r+16,u+a*.5,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(d.name,s-r+30,u+a*.75),i.fillStyle="#777",i.fillText(""+d.type,s-r+130,u+a*.75),u+=a}}this.drawButton(s-r,u+2,r-20,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)}drawButton(t,e,i,n,s,r=h.NODE_DEFAULT_COLOR,a="#555",l=h.NODE_TEXT_COLOR){var o=this.ctx,u=e+h.NODE_TITLE_HEIGHT+2,p=this.mouse,d=h.isInsideRectangle(p[0],p[1],t,u,i,n);p=this.last_click_position;var c=p&&h.isInsideRectangle(p[0],p[1],t,u,i,n);o.fillStyle=d?a:r,c&&(o.fillStyle="#AAA"),o.beginPath(),o.roundRect(t,e,i,n,[4]),o.fill(),s!=null&&s.constructor==String&&(o.fillStyle=l,o.textAlign="center",o.font=(n*.65|0)+"px Arial",o.fillText(s,t+i*.5,e+n*.75),o.textAlign="left");var _=c&&!this.block_click;return c&&this.blockClick(),_}drawGroups(t,e){if(this.graph){var i=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var n=0;n<i.length;++n){var s=i[n];if(h.overlapBounding(this.visible_area,s._bounding)){e.fillStyle=s.color||"#335",e.strokeStyle=s.color||"#335";var r=s._pos,a=s._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(r[0]+.5,r[1]+.5,a[0],a[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(r[0]+a[0],r[1]+a[1]),e.lineTo(r[0]+a[0]-10,r[1]+a[1]),e.lineTo(r[0]+a[0],r[1]+a[1]-10),e.fill();var l=s.font_size||h.DEFAULT_GROUP_FONT_SIZE;e.font=l+"px Arial",e.textAlign="left",e.fillText(s.title,r[0]+4,r[1]+l)}}e.restore()}}renderInfo(t,e=10,i){i=i||this.canvas.height-80,t.save(),t.translate(e,i),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),t.fillText("I: "+this.graph.iteration,5,13*2),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),t.fillText("V: "+this.graph._version,5,13*4),t.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;let i=this.viewport||[0,0,e.canvas.width,e.canvas.height];if(this.clear_background&&e.clearRect(i[0],i[1],i[2],i[3]),this._graph_stack&&this._graph_stack.length){e.save(),this._graph_stack[this._graph_stack.length-1];var n=this.graph._subgraph_node;e.strokeStyle=n.bgColor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=n.bgColor||"#AAA";for(var s="",r=1;r<this._graph_stack.length;++r)s+=this._graph_stack[r]._subgraph_node.getTitle()+" >> ";e.fillText(s+n.getTitle(),t.width*.5,40),e.restore()}let a=!1;if(this.onRenderBackground&&this.onRenderBackground(t,e)&&(a=!0),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.background_image&&this.ds.scale>.5&&!a){this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,(!this._bg_img||this._bg_img.name!=this.background_image)&&(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,this._bg_img.onload=()=>{this.draw(!0,!0)});var l=null;this._pattern==null&&this._bg_img.width>0?(l=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=l):l=this._pattern,l&&(e.fillStyle=l,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),h.debug&&(e.fillStyle="red",e.fillRect(this.visible_area[0]+10,this.visible_area[1]+10,this.visible_area[2]-20,this.visible_area[3]-20)),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,e){this.current_node=t;var i=t.color||t.constructor.color||h.NODE_DEFAULT_COLOR,n=t.bgColor||t.constructor.bgColor||h.NODE_DEFAULT_BGCOLOR;t.mouseOver;var s=this.ds.scale<.6;if(this.live_mode){t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));return}var r=this.editor_alpha;if(e.globalAlpha=r,this.render_shadows&&!s?(e.shadowColor=h.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!(t.flags.collapsed&&t.onDrawCollapsed&&t.onDrawCollapsed(e,this)==!0)){var a=t.shape||S.BOX_SHAPE,l=ie.temp_vec2;ie.temp_vec2.set(t.size);var o=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var u=t.getTitle?t.getTitle():t.title;u!=null&&(t._collapsed_width=Math.min(t.size[0],e.measureText(u).width+h.NODE_TITLE_HEIGHT*2),l[0]=t._collapsed_width,l[1]=0)}t.clip_area&&(e.save(),e.beginPath(),a==S.BOX_SHAPE?e.rect(0,0,l[0],l[1]):a==S.ROUND_SHAPE?e.roundRect(0,0,l[0],l[1],[10]):a==S.CIRCLE_SHAPE&&e.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),e.clip()),t.has_errors&&(n="red"),this.drawNodeShape(t,e,[l[0],l[1]],i,n,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=o?"center":"left",e.font=this.inner_text_font;var p=!s,d=this.connecting_output,c=this.connecting_input;e.lineWidth=1;var _=0,f=[0,0];if(t.flags.collapsed){if(this.render_collapsed_slots){var G=null,B=null;if(t.inputs)for(let R=0;R<t.inputs.length;R++){let w=t.inputs[R];if(w.link!=null){G=w;break}}if(t.outputs)for(let R=0;R<t.outputs.length;R++){let w=t.outputs[R];!w.links||!w.links.length||(B=w)}if(G){var z=0,F=h.NODE_TITLE_HEIGHT*-.5;o&&(z=t._collapsed_width*.5,F=-h.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),G.type===k.EVENT||G.shape===S.BOX_SHAPE?e.rect(z-7+.5,F-4,14,8):G.shape===S.ARROW_SHAPE?(e.moveTo(z+8,F),e.lineTo(z+-4,F-4),e.lineTo(z+-4,F+4),e.closePath()):e.arc(z,F,4,0,Math.PI*2),e.fill()}if(B){var z=t._collapsed_width,F=h.NODE_TITLE_HEIGHT*-.5;o&&(z=t._collapsed_width*.5,F=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),B.type===k.EVENT||B.shape===S.BOX_SHAPE?e.rect(z-7+.5,F-4,14,8):B.shape===S.ARROW_SHAPE?(e.moveTo(z+6,F),e.lineTo(z-6,F-4),e.lineTo(z-6,F+4),e.closePath()):e.arc(z,F,4,0,Math.PI*2),e.fill()}}}else{if(t.inputs)for(var g=0;g<t.inputs.length;g++){var m=t.inputs[g],y=m.type,E=m.shape;e.globalAlpha=r,this.connecting_output&&!h.isValidConnection(m.type,d.type)&&(e.globalAlpha=.4*r),e.fillStyle=m.link!=null?m.color_on||this.default_connection_color.input_on:m.color_off||this.default_connection_color.input_off;var v=t.getConnectionPos(!0,g,[f[0],f[1]]);v[0]-=t.pos[0],v[1]-=t.pos[1],_<v[1]+h.NODE_SLOT_HEIGHT*.5&&(_=v[1]+h.NODE_SLOT_HEIGHT*.5),e.beginPath();var b=!0;if(m.type===k.EVENT||m.shape===S.BOX_SHAPE?o?e.rect(v[0]-5+.5,v[1]-8+.5,10,14):e.rect(v[0]-6+.5,v[1]-5+.5,14,10):E===S.ARROW_SHAPE?(e.moveTo(v[0]+8,v[1]+.5),e.lineTo(v[0]-4,v[1]+6+.5),e.lineTo(v[0]-4,v[1]-6+.5),e.closePath()):E===S.GRID_SHAPE?(e.rect(v[0]-4,v[1]-4,2,2),e.rect(v[0]-1,v[1]-4,2,2),e.rect(v[0]+2,v[1]-4,2,2),e.rect(v[0]-4,v[1]-1,2,2),e.rect(v[0]-1,v[1]-1,2,2),e.rect(v[0]+2,v[1]-1,2,2),e.rect(v[0]-4,v[1]+2,2,2),e.rect(v[0]-1,v[1]+2,2,2),e.rect(v[0]+2,v[1]+2,2,2),b=!1):s?e.rect(v[0]-4,v[1]-4,8,8):e.arc(v[0],v[1],4,0,Math.PI*2),e.fill(),p){var C=m.label!=null?m.label:m.name;C&&(e.fillStyle=h.NODE_TEXT_COLOR,o||m.dir==I.UP?e.fillText(C,v[0],v[1]-10):e.fillText(C,v[0]+10,v[1]+5))}}if(e.textAlign=o?"center":"right",e.strokeStyle="black",t.outputs)for(let R=0;R<t.outputs.length;R++){let w=t.outputs[R];var y=w.type,E=w.shape;this.connecting_input&&!h.isValidConnection(y,c.type)&&(e.globalAlpha=.4*r);var v=t.getConnectionPos(!1,R,f);v[0]-=t.pos[0],v[1]-=t.pos[1],_<v[1]+h.NODE_SLOT_HEIGHT*.5&&(_=v[1]+h.NODE_SLOT_HEIGHT*.5),e.fillStyle=w.links&&w.links.length?w.color_on||this.default_connection_color.output_on:w.color_off||this.default_connection_color.output_off,e.beginPath();var b=!0;if(y===k.EVENT||E===S.BOX_SHAPE?o?e.rect(v[0]-5+.5,v[1]-8+.5,10,14):e.rect(v[0]-6+.5,v[1]-5+.5,14,10):E===S.ARROW_SHAPE?(e.moveTo(v[0]+8,v[1]+.5),e.lineTo(v[0]-4,v[1]+6+.5),e.lineTo(v[0]-4,v[1]-6+.5),e.closePath()):E===S.GRID_SHAPE?(e.rect(v[0]-4,v[1]-4,2,2),e.rect(v[0]-1,v[1]-4,2,2),e.rect(v[0]+2,v[1]-4,2,2),e.rect(v[0]-4,v[1]-1,2,2),e.rect(v[0]-1,v[1]-1,2,2),e.rect(v[0]+2,v[1]-1,2,2),e.rect(v[0]-4,v[1]+2,2,2),e.rect(v[0]-1,v[1]+2,2,2),e.rect(v[0]+2,v[1]+2,2,2),b=!1):s?e.rect(v[0]-4,v[1]-4,8,8):e.arc(v[0],v[1],4,0,Math.PI*2),e.fill(),!s&&b&&e.stroke(),p){var C=w.label!=null?w.label:w.name;C&&(e.fillStyle=h.NODE_TEXT_COLOR,o||w.dir==I.DOWN?e.fillText(C,v[0],v[1]-8):e.fillText(C,v[0]-10,v[1]+5))}}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var O=_;(o||t.widgets_up)&&(O=2),t.widgets_start_y!=null&&(O=t.widgets_start_y),this.drawNodeWidgets(t,O,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}}drawLinkTooltip(t,e){var i=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(i[0],i[1],3,0,Math.PI*2),t.fill(),e.data!=null&&!(this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,e,this)==!0)){var n=e.data,s=null;if(n.constructor===Number?s=n.toFixed(2):n.constructor===String?s='"'+n+'"':n.constructor===Boolean?s=String(n):n.toToolTip?s=n.toToolTip():s="["+n.constructor.name+"]",s!=null){s=s.substr(0,30),t.font="14px Courier New";var r=t.measureText(s),a=r.width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(i[0]-a*.5,i[1]-15-l,a,l,[3]),t.moveTo(i[0]-10,i[1]-15),t.lineTo(i[0]+10,i[1]-15),t.lineTo(i[0],i[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(s,i[0],i[1]-15-l*.3)}}}drawNodeShape(t,e,i,n,s,r,a){e.strokeStyle=n,e.fillStyle=s;var l=h.NODE_TITLE_HEIGHT,o=this.ds.scale<.5,u=t.shape||t.constructor.shape||S.ROUND_SHAPE,p=t.titleMode,d=!0;p==ee.TRANSPARENT_TITLE||p==ee.NO_TITLE?d=!1:p==ee.AUTOHIDE_TITLE&&a&&(d=!0);var c=ie.tmp_area;c[0]=0,c[1]=d?-l:0,c[2]=i[0]+1,c[3]=d?i[1]+l:i[1];var _=e.globalAlpha;if(e.beginPath(),u==S.BOX_SHAPE||o?e.fillRect(c[0],c[1],c[2],c[3]):u==S.ROUND_SHAPE||u==S.CARD_SHAPE?e.roundRect(c[0],c[1],c[2],c[3],u==S.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):u==S.CIRCLE_SHAPE&&e.arc(i[0]*.5,i[1]*.5,i[0]*.5,0,Math.PI*2),e.fill(),!t.flags.collapsed&&d&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,c[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),d||p==ee.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(e,this,l,i,this.ds.scale,n);else if(p!=ee.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var f=t.constructor.title_color||n;if(t.flags.collapsed&&(e.shadowColor=h.DEFAULT_SHADOW_COLOR),this.use_gradients){var g=T.gradients[f];g||(g=T.gradients[f]=e.createLinearGradient(0,0,400,0),g.addColorStop(0,f),g.addColorStop(1,"#000")),e.fillStyle=g}else e.fillStyle=f;e.beginPath(),u==S.BOX_SHAPE||o?e.rect(0,-l,i[0]+1,l):(u==S.ROUND_SHAPE||u==S.CARD_SHAPE)&&e.roundRect(0,-l,i[0]+1,l,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"}var m=null;h.node_box_coloured_by_mode&&_e[t.mode]&&(m=_e[t.mode]),h.node_box_coloured_when_on&&(m=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":m);var y=10;if(t.onDrawTitleBox?t.onDrawTitleBox(e,this,l,i,this.ds.scale):u==S.ROUND_SHAPE||u==S.CIRCLE_SHAPE||u==S.CARD_SHAPE?(o&&(e.fillStyle="black",e.beginPath(),e.arc(l*.5,l*-.5,y*.5+1,0,Math.PI*2),e.fill()),e.fillStyle=t.boxcolor||m||h.NODE_DEFAULT_BOXCOLOR,o?e.fillRect(l*.5-y*.5,l*-.5-y*.5,y,y):(e.beginPath(),e.arc(l*.5,l*-.5,y*.5,0,Math.PI*2),e.fill())):(o&&(e.fillStyle="black",e.fillRect((l-y)*.5-1,(l+y)*-.5-1,y+2,y+2)),e.fillStyle=t.boxcolor||m||h.NODE_DEFAULT_BOXCOLOR,e.fillRect((l-y)*.5,(l+y)*-.5,y,y)),e.globalAlpha=_,t.onDrawTitleText&&t.onDrawTitleText(e,this,l,i,this.ds.scale,this.title_text_font,r),!o){e.font=this.title_text_font;var E=String(t.getTitle());E&&(r?e.fillStyle=h.NODE_SELECTED_TITLE_COLOR:e.fillStyle=t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.fillText(E.substr(0,20),l,h.NODE_TITLE_TEXT_Y-l),e.textAlign="left"):(e.textAlign="left",e.fillText(E,l,h.NODE_TITLE_TEXT_Y-l)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var v=h.NODE_TITLE_HEIGHT,b=t.size[0]-v,C=h.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],b+2,-v+2,v-4,v-4);e.fillStyle=C?"#888":"#555",u==S.BOX_SHAPE||o?e.fillRect(b+2,-v+2,v-4,v-4):(e.beginPath(),e.roundRect(b+2,-v+2,v-4,v-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(b+v*.2,-v*.6),e.lineTo(b+v*.8,-v*.6),e.lineTo(b+v*.5,-v*.3),e.fill()}t.onDrawTitle&&t.onDrawTitle(e,this)}r&&(t.onBounding&&t.onBounding(c),p==ee.TRANSPARENT_TITLE&&(c[1]-=l,c[3]+=l),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),u==S.BOX_SHAPE?e.rect(-6+c[0],-6+c[1],12+c[2],12+c[3]):u==S.ROUND_SHAPE||u==S.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2]):u==S.CARD_SHAPE?e.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2,2,this.round_radius*2,2]):u==S.CIRCLE_SHAPE&&e.arc(i[0]*.5,i[1]*.5,i[0]*.5+6,0,Math.PI*2),e.strokeStyle=h.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=n,e.globalAlpha=1),t.execute_triggered>0&&t.execute_triggered--,t.action_triggered>0&&t.action_triggered--}drawConnections(t){var e=h.getTime(),i=this.visible_area;let n=ie.margin_area;n[0]=i[0]-20,n[1]=i[1]-20,n[2]=i[2]+40,n[3]=i[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,r=0,a=s.length;r<a;++r){var l=s[r];if(!(!l.inputs||!l.inputs.length))for(var o=0;o<l.inputs.length;++o){var u=l.inputs[o];if(!u||u.link==null)continue;var p=u.link,d=this.graph.links[p];if(!d)continue;var c=this.graph.getNodeById(d.origin_id);if(c==null)continue;var _=d.origin_slot,f=null;_==-1?f=[c.pos[0]+10,c.pos[1]+10]:f=c.getConnectionPos(!1,_,ie.tempA);var g=l.getConnectionPos(!0,o,ie.tempB);let O=ie.link_bounding;if(O[0]=f[0],O[1]=f[1],O[2]=g[0]-f[0],O[3]=g[1]-f[1],O[2]<0&&(O[0]+=O[2],O[2]=Math.abs(O[2])),O[3]<0&&(O[1]+=O[3],O[3]=Math.abs(O[3])),!!h.overlapBounding(O,n)){var m=c.outputs[_],y=l.inputs[o];if(!(!m||!y)){var E=m.dir||(c.horizontal?I.DOWN:I.RIGHT),v=y.dir||(l.horizontal?I.UP:I.LEFT);if(this.renderLink(t,f,g,d,!1,!1,null,E,v),d&&d._last_time&&e-d._last_time<1e3){var b=2-(e-d._last_time)*.002,C=t.globalAlpha;t.globalAlpha=C*b,this.renderLink(t,f,g,d,!0,!0,"white",E,v),t.globalAlpha=C}}}}}t.globalAlpha=1}renderLink(t,e,i,n,s,r,a,l,o,u){n&&this.visible_links.push(n),!a&&n&&(a=n.color||T.link_type_colors[n.type]),a||(a=this.default_link_color),n!=null&&this.highlighted_links[n.id]&&(a="#FFF"),l=l||I.RIGHT,o=o||I.LEFT;var p=h.distance(e,i);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",u=u||1,u>1&&(t.lineWidth=.5),t.beginPath();for(var d=0;d<u;d+=1){var c=(d-(u-1)*.5)*5;if(this.links_render_mode==ae.SPLINE_LINK){t.moveTo(e[0],e[1]+c);var _=0,f=0,g=0,m=0;switch(l){case I.LEFT:_=p*-.25;break;case I.RIGHT:_=p*.25;break;case I.UP:f=p*-.25;break;case I.DOWN:f=p*.25;break}switch(o){case I.LEFT:g=p*-.25;break;case I.RIGHT:g=p*.25;break;case I.UP:m=p*-.25;break;case I.DOWN:m=p*.25;break}t.bezierCurveTo(e[0]+_,e[1]+f+c,i[0]+g,i[1]+m+c,i[0],i[1]+c)}else if(this.links_render_mode==ae.LINEAR_LINK){t.moveTo(e[0],e[1]+c);var _=0,f=0,g=0,m=0;switch(l){case I.LEFT:_=-1;break;case I.RIGHT:_=1;break;case I.UP:f=-1;break;case I.DOWN:f=1;break}switch(o){case I.LEFT:g=-1;break;case I.RIGHT:g=1;break;case I.UP:m=-1;break;case I.DOWN:m=1;break}var y=15;t.lineTo(e[0]+_*y,e[1]+f*y+c),t.lineTo(i[0]+g*y,i[1]+m*y+c),t.lineTo(i[0],i[1]+c)}else if(this.links_render_mode==ae.STRAIGHT_LINK){t.moveTo(e[0],e[1]);var E=e[0],v=e[1],b=i[0],C=i[1];l==I.RIGHT?E+=10:v+=10,o==I.LEFT?b-=10:C-=10,t.lineTo(E,v),t.lineTo((E+b)*.5,v),t.lineTo((E+b)*.5,C),t.lineTo(b,C),t.lineTo(i[0],i[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!s&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var O=this.computeConnectionPoint(e,i,.5,l,o);if(n&&n._pos&&(n._pos[0]=O[0],n._pos[1]=O[1]),this.ds.scale>=.6&&this.highquality_render&&o!=I.CENTER){if(this.render_connection_arrows){var G=this.computeConnectionPoint(e,i,.25,l,o),B=this.computeConnectionPoint(e,i,.26,l,o),z=this.computeConnectionPoint(e,i,.75,l,o),F=this.computeConnectionPoint(e,i,.76,l,o),R=0,w=0;this.render_curved_connections?(R=-Math.atan2(B[0]-G[0],B[1]-G[1]),w=-Math.atan2(F[0]-z[0],F[1]-z[1])):w=R=i[1]>e[1]?0:Math.PI,t.save(),t.translate(G[0],G[1]),t.rotate(R),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(z[0],z[1]),t.rotate(w),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(O[0],O[1],5,0,Math.PI*2),t.fill()}if(r){t.fillStyle=a;for(var d=0;d<5;++d){var L=(h.getTime()*.001+d*.2)%1,O=this.computeConnectionPoint(e,i,L,l,o);t.beginPath(),t.arc(O[0],O[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,e,i,n=I.RIGHT,s=I.LEFT){var r=h.distance(t,e),a=t,l=[t[0],t[1]],o=[e[0],e[1]],u=e;switch(n){case I.LEFT:l[0]+=r*-.25;break;case I.RIGHT:l[0]+=r*.25;break;case I.UP:l[1]+=r*-.25;break;case I.DOWN:l[1]+=r*.25;break}switch(s){case I.LEFT:o[0]+=r*-.25;break;case I.RIGHT:o[0]+=r*.25;break;case I.UP:o[1]+=r*-.25;break;case I.DOWN:o[1]+=r*.25;break}var p=(1-i)*(1-i)*(1-i),d=3*((1-i)*(1-i))*i,c=3*(1-i)*(i*i),_=i*i*i,f=p*a[0]+d*l[0]+c*o[0]+_*u[0],g=p*a[1]+d*l[1]+c*o[1]+_*u[1];return[f,g]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,i=0;i<e.length;++i){var n=e[i];t.fillStyle="black",t.fillRect(n.pos[0]-h.NODE_TITLE_HEIGHT,n.pos[1]-h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT),n.order==0&&t.strokeRect(n.pos[0]-h.NODE_TITLE_HEIGHT+.5,n.pos[1]-h.NODE_TITLE_HEIGHT+.5,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(""+n.order,n.pos[0]+h.NODE_TITLE_HEIGHT*-.5,n.pos[1]-6)}t.globalAlpha=1}drawNodeWidgets(t,e,i,n){if(!(!t.widgets||!t.widgets.length)){var s=t.size[0],r=t.widgets;e+=2;var a=h.NODE_WIDGET_HEIGHT,l=this.ds.scale>.5;i.save(),i.globalAlpha=this.editor_alpha;for(var o=h.WIDGET_OUTLINE_COLOR,u=h.WIDGET_BGCOLOR,p=h.WIDGET_TEXT_COLOR,d=h.WIDGET_SECONDARY_TEXT_COLOR,c=15,_=0;_<r.length;++_){var f=r[_],g=e;f.y&&(g=f.y),f.last_y=g,i.strokeStyle=o,i.fillStyle="#222",i.textAlign="left",f.disabled&&(i.globalAlpha*=.5);var m=f.width||s;switch(f.type){case"button":f.clicked&&(i.fillStyle="#AAA",f.clicked=!1,this.dirty_canvas=!0),i.fillRect(c,g,m-c*2,a),l&&!f.disabled&&!h.ignore_all_widget_events&&i.strokeRect(c,g,m-c*2,a),l&&(i.textAlign="center",i.fillStyle=p,i.fillText(f.name,m*.5,g+a*.7));break;case"toggle":i.textAlign="left",i.strokeStyle=o,i.fillStyle=u,i.beginPath(),l?i.roundRect(c,g,m-c*2,a,[a*.5]):i.rect(c,g,m-c*2,a),i.fill(),l&&!f.disabled&&!h.ignore_all_widget_events&&i.stroke(),i.fillStyle=f.value?"#89A":"#333",i.beginPath(),i.arc(m-c*2,g+a*.5,a*.36,0,Math.PI*2),i.fill(),l&&(i.fillStyle=d,f.name!=null&&i.fillText(f.name,c*2,g+a*.7),i.fillStyle=f.value?p:d,i.textAlign="right",i.fillText(f.value?f.options.on||"true":f.options.off||"false",m-40,g+a*.7));break;case"slider":i.fillStyle=u,i.fillRect(c,g,m-c*2,a);var y=f.options.max-f.options.min,E=(f.value-f.options.min)/y;if(i.fillStyle=n==f?"#89A":"#678",i.fillRect(c,g,E*(m-c*2),a),l&&!f.disabled&&i.strokeRect(c,g,m-c*2,a),f.marker){var v=(+f.marker-f.options.min)/y;i.fillStyle="#AA9",i.fillRect(c+v*(m-c*2),g,2,a)}l&&(i.textAlign="center",i.fillStyle=p,i.fillText(f.name+"  "+Number(f.value).toFixed(3),m*.5,g+a*.7));break;case"number":case"combo":if(i.textAlign="left",i.strokeStyle=o,i.fillStyle=u,i.beginPath(),l?i.roundRect(c,g,m-c*2,a,[a*.5]):i.rect(c,g,m-c*2,a),i.fill(),l)if(!f.disabled&&!h.ignore_all_widget_events&&i.stroke(),i.fillStyle=p,!f.disabled&&!h.ignore_all_widget_events&&(i.beginPath(),i.moveTo(c+16,g+5),i.lineTo(c+6,g+a*.5),i.lineTo(c+16,g+a-5),i.fill(),i.beginPath(),i.moveTo(m-c-16,g+5),i.lineTo(m-c-6,g+a*.5),i.lineTo(m-c-16,g+a-5),i.fill()),i.fillStyle=d,i.fillText(f.name,c*2+5,g+a*.7),i.fillStyle=p,i.textAlign="right",f.type=="number")i.fillText(Number(f.value).toFixed(f.options.precision!==void 0?f.options.precision:3),m-c*2-20,g+a*.7);else{var b=f.value;if(f.options.values){var C=f.options.values;C.constructor===Function&&(C=C()),C&&C.constructor!==Array&&(b=C[f.value])}i.fillText(b,m-c*2-20,g+a*.7)}break;case"string":case"text":i.textAlign="left",i.strokeStyle=o,i.fillStyle=u,i.beginPath(),l?i.roundRect(c,g,m-c*2,a,[a*.5]):i.rect(c,g,m-c*2,a),i.fill(),l&&(f.disabled||i.stroke(),i.save(),i.beginPath(),i.rect(c,g,m-c*2,a),i.clip(),i.fillStyle=d,f.name!=null&&i.fillText(f.name,c*2,g+a*.7),i.fillStyle=p,i.textAlign="right",i.fillText(String(f.value).substr(0,30),m-c*2,g+a*.7),i.restore());break;default:f.draw&&f.draw(i,t,m,g,a);break}e+=(f.computeSize?f.computeSize(m)[1]:a)+4,i.globalAlpha=this.editor_alpha}i.restore(),i.textAlign="left"}}};let P=ie;P.temp=new Float32Array(4),P.temp_vec2=new Float32Array(2),P.tmp_area=new Float32Array(4),P.margin_area=new Float32Array(4),P.link_bounding=new Float32Array(4),P.tempA=[0,0],P.tempB=[0,0];class le{constructor(e="Group"){this.fontSize=h.DEFAULT_GROUP_FONT_SIZE,this._nodes=[],this.graph=null,this._bounding=new Float32Array([10,10,140,80]),this.title=e,this.color=T.node_colors.pale_blue?T.node_colors.pale_blue.groupcolor:"#AAA",this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4)}get bounding(){return this._bounding}get pos(){return[this._pos[0],this._pos[1]]}set pos(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])}get size(){return[this._size[0],this._size[1]]}set size(e){!e||e.length<2||(this._size[0]=Math.max(140,e[0]),this._size[1]=Math.max(80,e[1]))}configure(e){e.bounding,this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,this.font=e.font}serialize(){const e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font:this.font}}move(e,i,n){if(this._pos[0]+=e,this._pos[1]+=i,!n)for(var s=0;s<this._nodes.length;++s){var r=this._nodes[s];r.pos[0]+=e,r.pos[1]+=i}}recomputeInsideNodes(){this._nodes.length=0;for(var e=this.graph._nodes,i=new Float32Array(4),n=0;n<e.length;++n){var s=e[n];s.getBounding(i),h.overlapBounding(this._bounding,i)&&this._nodes.push(s)}}isPointInside(e,i,n=0,s=!1){var r=this.graph&&this.graph.isLive()?0:h.NODE_TITLE_HEIGHT;return s&&(r=0),this.pos[0]-4-n<e&&this.pos[0]+this.size[0]+4+n>e&&this.pos[1]-r-n<i&&this.pos[1]+this.size[1]+n>i}setDirtyCanvas(e,i=!1){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,i])}}class N{static onMenuCollapseAll(){}static onMenuNodeEdit(){}prompt(e="",i,n,s,r=!1){var a=this,l=document.createElement("div");l.is_modified=!1,l.className="graphdialog rounded",r?l.innerHTML=`
<span class='name'></span>
<textarea autofocus class='value'></textarea>
<button class='rounded'>OK</button>
`:l.innerHTML=`
<span class='name'></span>
<input autofocus type='text' class='value'/>
<button class='rounded'>OK</button>`,l.close=function(){a.prompt_box=null,l.parentNode&&l.parentNode.removeChild(l)};var o=T.active_canvas,u=o.canvas;u.parentNode.appendChild(l),this.ds.scale>1&&(l.style.transform="scale("+this.ds.scale+")");var p=null,d=0;h.pointerListenerAdd(l,"leave",function(b){d||h.dialog_close_on_mouse_leave&&!l.is_modified&&h.dialog_close_on_mouse_leave&&(p=setTimeout(l.close,h.dialog_close_on_mouse_leave_delay))}),h.pointerListenerAdd(l,"enter",function(b){h.dialog_close_on_mouse_leave&&p&&clearTimeout(p)});var c=l.querySelectorAll("select");c&&c.forEach(function(b){b.addEventListener("click",function(C){d++}),b.addEventListener("blur",function(C){d=0}),b.addEventListener("change",function(C){d=-1})}),a.prompt_box&&a.prompt_box.close(),a.prompt_box=l;var _=l.querySelector(".name");_.innerText=e;let f=l.querySelector(".value");f.value=i;var g=f;g.addEventListener("keydown",function(b){if(l.is_modified=!0,b.keyCode==27)l.close();else if(b.keyCode==13&&b.target instanceof Element&&b.target.localName!="textarea")n&&n(this.value),l.close();else return;b.preventDefault(),b.stopPropagation()});var m=l.querySelector("button");m.addEventListener("click",function(b){n&&n(g.value),a.setDirty(!0),l.close()});var y=u.getBoundingClientRect(),E=-20,v=-20;return y&&(E-=y.left,v-=y.top),s?(l.style.left=s.clientX+E+"px",l.style.top=s.clientY+v+"px"):(l.style.left=u.width*.5+E+"px",l.style.top=u.height*.5+v+"px"),setTimeout(function(){g.focus()},10),l}showSearchBox(e,i={}){var n={slotFrom:null,node_from:null,node_to:null,do_type_filter:h.search_filter_enabled,type_filter_in:null,type_filter_out:null,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:h.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:h.search_show_all_on_open};i=Object.assign(n,i);var s=this,r=T.active_canvas,a=r.canvas,l=a.ownerDocument||document;let o=e;var u=document.createElement("div");if(u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",i.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),u.innerHTML+="<div class='helper'></div>",l.fullscreenElement?l.fullscreenElement.appendChild(u):(l.body.appendChild(u),l.body.style.overflow="hidden"),i.do_type_filter)var p=u.querySelector(".slot_in_type_filter"),d=u.querySelector(".slot_out_type_filter");if(u.close=function(){s.search_box=null,this.blur(),a.focus(),l.body.style.overflow="",setTimeout(function(){s.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},this.ds.scale>1&&(u.style.transform="scale("+this.ds.scale+")"),i.hide_on_mouse_leave){var c=0,_=null;h.pointerListenerAdd(u,"enter",function(L){_&&(clearTimeout(_),_=null)}),h.pointerListenerAdd(u,"leave",function(L){c||(_=setTimeout(function(){u.close()},500))}),i.do_type_filter&&(p.addEventListener("click",function(L){c++}),p.addEventListener("blur",function(L){c=0}),p.addEventListener("change",function(L){c=-1}),d.addEventListener("click",function(L){c++}),d.addEventListener("blur",function(L){c=0}),d.addEventListener("change",function(L){c=-1}))}s.search_box&&s.search_box.close(),s.search_box=u;var f=u.querySelector(".helper"),g=null,m=null,y=null,E=u.querySelector("input");if(E&&(E.addEventListener("blur",function(L){this.focus()}),E.addEventListener("keydown",function(L){if(L.keyCode==38)R(!1);else if(L.keyCode==40)R(!0);else if(L.keyCode==27)u.close();else if(L.keyCode==13)y?F(y.innerHTML):g?F(g):u.close();else{m&&clearInterval(m),m=setTimeout(w,250);return}return L.preventDefault(),L.stopPropagation(),L.stopImmediatePropagation(),!0})),i.do_type_filter){if(p){var v=h.slot_types_in,b=v.length;(i.type_filter_in==k.EVENT||i.type_filter_in==k.ACTION)&&(i.type_filter_in="_event_");for(var C=0;C<b;C++){var O=document.createElement("option");O.value=v[C],O.innerHTML=v[C],p.appendChild(O),i.type_filter_in!==null&&(i.type_filter_in+"").toLowerCase()==(v[C]+"").toLowerCase()&&(O.selected=!0)}p.addEventListener("change",function(){w()})}if(d){var v=h.slot_types_out,b=v.length;(i.type_filter_out==k.EVENT||i.type_filter_out==k.ACTION)&&(i.type_filter_out="_event_");for(var C=0;C<b;C++){var O=document.createElement("option");O.value=v[C],O.innerHTML=v[C],d.appendChild(O),i.type_filter_out!==null&&(i.type_filter_out+"").toLowerCase()==(v[C]+"").toLowerCase()&&(O.selected=!0)}d.addEventListener("change",function(){w()})}}var G=a.getBoundingClientRect(),B=(o?o.clientX:G.left+G.width*.5)-80,z=(o?o.clientY:G.top+G.height*.5)-20;u.style.left=B+"px",u.style.top=z+"px",o.layerY>G.height-200&&(f.style.maxHeight=G.height-o.layerY-20+"px"),E.focus(),i.show_all_on_open&&w();function F(L){if(L)if(s.onSearchBoxSelection)s.onSearchBoxSelection(L,o,r);else{var M=h.searchbox_extras[L.toLowerCase()];M&&(L=M.type),r.graph.beforeChange();var W=h.createNode(L);if(W&&(W.pos=r.convertEventToCanvasOffset(o),r.graph.add(W)),M&&M.data){if(M.data.properties)for(var x in M.data.properties)W.addProperty(""+x,M.data.properties[x]);if(M.data.inputs){W.inputs=[];for(var x in M.data.inputs)W.addInput(M.data.inputs[x][0],M.data.inputs[x][1])}if(M.data.outputs){W.outputs=[];for(var x in M.data.outputs)W.addOutput(M.data.outputs[x][0],M.data.outputs[x][1])}M.data.title&&(W.title=M.data.title),M.data.json&&W.configure(M.data.json)}if(i.node_from){var H=null;switch(typeof i.slotFrom){case"string":H=i.node_from.findOutputSlotIndexByName(i.slotFrom);break;case"object":i.slotFrom.name?H=i.node_from.findOutputSlotIndexByName(i.slotFrom.name):H=-1,H==-1&&typeof i.slotFrom.slot_index<"u"&&(H=i.slotFrom.slot_index);break;case"number":H=i.slotFrom;break;default:H=0}H=H,typeof i.node_from.outputs[H]!==void 0&&H!==null&&H>-1&&i.node_from.connectByTypeInput(H,W,i.node_from.outputs[H].type)}if(i.node_to){var H=null;switch(typeof i.slotFrom){case"string":H=i.node_to.findInputSlotIndexByName(i.slotFrom);break;case"number":H=i.slotFrom;break;default:H=0}typeof i.node_to.inputs[H]!==void 0&&H!==null&&H>-1&&i.node_to.connectByTypeOutput(H,W,i.node_to.inputs[H].type)}r.graph.afterChange()}u.close()}function R(L){var M=y;y&&y.classList.remove("selected"),y?(y=L?y.nextSibling:y.previousSibling,y||(y=M)):y=L?f.childNodes[0]:f.childNodes[f.childNodes.length],y&&(y.classList.add("selected"),y.scrollIntoView({block:"end",behavior:"smooth"}))}function w(){m=null;var L=E.value;if(g=null,f.innerHTML="",!L&&!i.show_all_if_empty)return;if(s.onSearchBox){var M=s.onSearchBox(f,L,r);if(M)for(var W=0;W<M.length;++W)pe(M[W])}else{let se=function(q,K={}){var we={skipFilter:!1,inTypeOverride:null,outTypeOverride:null},ce=Object.assign(we,K),De=h.registered_node_types[q];if(H&&De.filter!=H||(!i.show_all_if_empty||L)&&q.toLowerCase().indexOf(L)===-1)return!1;if(i.do_type_filter&&!ce.skipFilter){var Ae=q,Q=V==null?void 0:V.value;if(ce.inTypeOverride!==!1&&(Q=ce.inTypeOverride),V&&Q&&h.registered_slot_in_types[Q]&&h.registered_slot_in_types[Q].nodes){var Ee=h.registered_slot_in_types[Q].nodes.includes(Ae);if(Ee===!1)return!1}var Q=X==null?void 0:X.value;if(ce.outTypeOverride!==!1&&(Q=ce.outTypeOverride),X&&Q&&h.registered_slot_out_types[Q]&&h.registered_slot_out_types[Q].nodes){var Ee=h.registered_slot_out_types[Q].nodes.includes(Ae);if(Ee===!1)return!1}}return!0};var x=0;L=L.toLowerCase();var H=r.filter||r.graph.filter;let V,X;i.do_type_filter&&s.search_box?(V=s.search_box.querySelector(".slot_in_type_filter"),X=s.search_box.querySelector(".slot_out_type_filter")):(V=null,X=null);for(const q in h.searchbox_extras){var $=h.searchbox_extras[q];if(!((!i.show_all_if_empty||L)&&$.desc.toLowerCase().indexOf(L)===-1)){var ke=h.registered_node_types[$.type];if(!(ke&&ke.filter!=H)&&se($.type)&&(pe($.desc,"searchbox_extra"),T.search_limit!==-1&&x++>T.search_limit))break}}var ue=null;if(Array.prototype.filter)var Le=Object.keys(h.registered_node_types),ue=Le.filter(K=>se(K));else{ue=[];for(const q in h.registered_node_types)se(q)&&ue.push(q)}for(var W=0;W<ue.length&&(pe(ue[W]),!(T.search_limit!==-1&&x++>T.search_limit));W++);if(i.show_general_after_typefiltered&&(V!=null&&V.value||X!=null&&X.value)){let q=[];for(const K in h.registered_node_types)se(K,{inTypeOverride:V&&V.value?"*":null,outTypeOverride:X&&X.value?"*":null})&&q.push(K);for(let K=0;K<q.length&&(pe(q[K],"generic_type"),!(T.search_limit!==-1&&x++>T.search_limit));K++);}if((V!=null&&V.value||X!=null&&X.value)&&(f==null?void 0:f.childNodes.length)==0&&i.show_general_if_none_on_typefilter){let q=[];for(const K in h.registered_node_types)se(K,{skipFilter:!0})&&q.push(K);for(let K=0;K<q.length&&(pe(q[K],"not_in_filter"),!(T.search_limit!==-1&&x++>T.search_limit));K++);}}function pe(se,V){var X=document.createElement("div");g||(g=se),X.innerText=se,X.dataset.type=escape(se),X.className="litegraph lite-search-item",V&&(X.className+=" "+V),X.addEventListener("click",function(q){F(unescape(this.dataset.type))}),f.appendChild(X)}}return u}showShowNodePanel(e){this.closePanels();var i=this.getCanvasWindow(),n=this,s=this.createPanel(e.title||"",{closable:!0,window:i,onOpen:function(){},onClose:function(){n.node_panel=null}});n.node_panel=s,s.id="node-panel",s.node=e,s.classList.add("settings");function r(){s.content.innerHTML="",s.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),s.addHTML("<h3>Properties</h3>");var a=function(d,c){switch(n.graph.beforeChange(e),d){case"Title":e.title=c;break;case"Mode":var _=Object.values(ne).indexOf(c);_>=j.ALWAYS&&ne[_]?e.changeMode(_):console.warn("unexpected mode: "+c);break;case"Color":T.node_colors[c]?(e.color=T.node_colors[c].color,e.bgColor=T.node_colors[c].bgColor):console.warn("unexpected color: "+c);break;default:e.setProperty(d,c);break}n.graph.afterChange(),n.dirty_canvas=!0};s.addWidget("string","Title",e.title,{},a),s.addWidget("combo","Mode",ne[e.mode],{values:ne},a);var l="";e.color!==void 0&&(l=Object.keys(T.node_colors).filter(function(d){return T.node_colors[d].color==e.color})[0]),s.addWidget("combo","Color",l,{values:Object.keys(T.node_colors)},a);for(var o in e.properties){var u=e.properties[o],p=e.getPropertyInfo(o);p.type,!(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(o,s))&&s.addWidget(p.widget||p.type,o,u,p,a)}s.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(s),s.footer.innerHTML="",s.addButton("Delete",function(){e.block_delete||(e.graph.remove(e),s.close())}).classList.add("delete")}s.inner_showCodePad=function(a){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";var l=s.alt_content.querySelector("textarea"),o=function(){s.toggleAltContent(!1),s.toggleFooterVisibility(!0),l.parentNode.removeChild(l),s.classList.add("settings"),s.classList.remove("centered"),r()};l.value=e.properties[a],l.addEventListener("keydown",function(d){d.code=="Enter"&&d.ctrlKey&&(e.setProperty(a,l.value),o())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),l.style.height="calc(100% - 40px)";var u=s.addButton("Assign",function(){e.setProperty(a,l.value),o()});s.alt_content.appendChild(u);var p=s.addButton("Close",o);p.style.float="right",s.alt_content.appendChild(p)},r(),this.canvas.parentNode.appendChild(s)}showSubgraphPropertiesDialog(e){console.log("showing subgraph properties dialog");var i=this.canvas.parentNode.querySelector(".subgraph_dialog");i&&i.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});n.node=e,n.classList.add("subgraph_dialog");function s(){if(n.clear(),e.inputs)for(var l=0;l<e.inputs.length;++l){var o=e.inputs[l];if(!o.not_subgraph_input){var u=`
<button>&#10005;</button>
<span class='bullet_icon'></span>
<span class='name'></span>
<span class='type'></span>`,p=n.addHTML(u,"subgraph_property");p.dataset.name=o.name,p.dataset.slot=""+l,p.querySelector(".name").innerText=o.name,p.querySelector(".type").innerText=""+o.type,p.querySelector("button").addEventListener("click",function(d){e.removeInput(Number(this.parentNode.dataset.slot)),s()})}}}var r=`
+
<span class='label'>Name</span>
<input class='name'/>
<span class='label'>Type</span>
<input class='type'></input>
<button>+</button>`,a=n.addHTML(r,"subgraph_property extra",!0);return a.querySelector("button").addEventListener("click",function(l){var o=this.parentNode,u=o.querySelector(".name").value,p=o.querySelector(".type").value;!u||e.findInputSlotIndexByName(u)!=-1||(e.addInput(u,p),o.querySelector(".name").value="",o.querySelector(".type").value="",s())}),s(),this.canvas.parentNode.appendChild(n),n}showSubgraphPropertiesDialogRight(e){var i=this.canvas.parentNode.querySelector(".subgraph_dialog");i&&i.close();var n=this.createPanel("Subgraph Outputs",{closable:!0,width:500});n.node=e,n.classList.add("subgraph_dialog");function s(){if(n.clear(),e.outputs)for(var o=0;o<e.outputs.length;++o){var u=e.outputs[o];if(!u.not_subgraph_output){var p=`
<button>&#10005;</button>
<span class='bullet_icon'></span>
<span class='name'></span>
<span class='type'></span>`,d=n.addHTML(p,"subgraph_property");d.dataset.name=u.name,d.dataset.slot=""+o,d.querySelector(".name").innerText=u.name,d.querySelector(".type").innerText=""+u.type,d.querySelector("button").addEventListener("click",function(c){e.removeOutput(Number(this.parentNode.dataset.slot)),s()})}}}var r=`
+
<span class='label'>Name</span>
<input class='name'/>
<span class='label'>Type</span>
<input class='type'></input>
<button>+</button>`,a=n.addHTML(r,"subgraph_property extra",!0);a.querySelector(".name").addEventListener("keydown",function(o){o.keyCode==13&&l.apply(this)}),a.querySelector("button").addEventListener("click",function(o){l.apply(this)});function l(){var o=this.parentNode,u=o.querySelector(".name").value,p=o.querySelector(".type").value;!u||e.findOutputSlotIndexByName(u)!=-1||(e.addOutput(u,p),o.querySelector(".name").value="",o.querySelector(".type").value="",s())}return s(),this.canvas.parentNode.appendChild(n),n}showConnectionMenu(e={}){var i=this,n=e.nodeFrom&&e.slotFrom,s=!n&&e.nodeTo&&e.slotTo;if(!n&&!s)return console.warn("No data passed to showConnectionMenu"),!1;var r=n?e.nodeFrom:e.nodeTo,a=n?e.slotFrom:e.slotTo,l=null;switch(typeof a){case"string":l=n?r.findOutputSlotIndexByName(a):r.findInputSlotIndexByName(a),a=n?r.outputs[a]:r.inputs[a];break;case"object":l=n?r.findOutputSlotIndexByName(a.name):r.findInputSlotIndexByName(a.name);break;case"number":l=a,a=n?r.outputs[a]:r.inputs[a];break;default:return console.warn("Cant get slot information "+a),!1}a=a;var o=[{content:"Add Node"},Z.SEPARATOR];i.allow_searchbox&&(o.push({content:"Search"}),o.push(Z.SEPARATOR));var u=a.type==k.EVENT?"_event_":a.type,p=n?h.slot_types_default_out:h.slot_types_default_in;const d=p[u];if(p&&p[u])if(Array.isArray(d))for(var c of d)o.push({content:d[c]});else typeof d=="object"?o.push({content:d.node}):o.push({content:d});var _=new Y(o,{event:e.e,title:(a&&a.name!=""?a.name+(u?" | ":""):"")+(a&&u?u:""),callback:f});function f(g,m,y){switch(g.content){case"Add Node":T.onMenuAdd(g,m,y,_,function(v){n?e.nodeFrom.connectByTypeInput(l,v,u):e.nodeTo.connectByTypeOutput(l,v,u)});break;case"Search":n?i.showSearchBox(y,{node_from:e.nodeFrom,slotFrom:a,type_filter_in:u}):i.showSearchBox(y,{node_to:e.nodeTo,slotFrom:a,type_filter_out:u});break;default:const E=Object.assign(e,{position:[e.e.canvasX,e.e.canvasY]});i.createDefaultNodeForSlot(g.content,E);break}}return!1}showLinkMenu(e,i){var n=this,s=n.graph.getNodeById(e.origin_id),r=n.graph.getNodeById(e.target_id),a=null;s&&s.outputs&&s.outputs[e.origin_slot]&&(a=s.outputs[e.origin_slot].type);var l=null;r&&r.outputs&&r.outputs[e.target_slot]&&(l=r.inputs[e.target_slot].type);var o=["Add Node",Z.SEPARATOR,"Delete",Z.SEPARATOR],u=new Y(o,{event:i,title:e.data!=null?e.data.constructor.name:null,callback:p});function p(d,c,_){switch(d.content){case"Add Node":T.onMenuAdd(null,null,_,u,function(f){!f.inputs||!f.inputs.length||!f.outputs||!f.outputs.length||s.connectByTypeInput(e.origin_slot,f,a)&&(f.connectByTypeInput(e.target_slot,r,l),f.pos[0]-=f.size[0]*.5)});break;case"Delete":n.graph.removeLink(e.id);break}}return!1}showEditPropertyValue(e,i,n){if(!e||e.properties[i]===void 0||h.ignore_all_widget_events)return;n=n||{};var s=e.getPropertyInfo(i),r=s.type,a="";if(r=="string"||r=="number"||r=="array"||r=="object")a="<input autofocus type='text' class='value'/>";else if((r=="enum"||r=="combo")&&s.values){a="<select autofocus type='text' class='value'>";for(var l in s.values){var o=l;s.values instanceof Array&&(o=s.values[l]),a+="<option value='"+o+"' "+(o==e.properties[i]?"selected":"")+">"+s.values[l]+"</option>"}a+="</select>"}else if(r=="boolean"||r=="toggle")a="<input autofocus type='checkbox' class='value' "+(e.properties[i]?"checked":"")+"/>";else{console.warn("unknown type: "+r);return}var u=this.createDialog("<span class='name'>"+(s.label?s.label:i)+"</span>"+a+"<button>OK</button>",n),p=null;if((r=="enum"||r=="combo")&&s.values)p=u.querySelector("select"),p.addEventListener("change",function(f){u.modified(),c(f.target.value)});else if(r=="boolean"||r=="toggle")p=u.querySelector("input"),p&&p.addEventListener("click",function(f){u.modified(),c(!!p.checked)});else if(p=u.querySelector("input"),p){p.addEventListener("blur",function(g){this.focus()});let f=e.properties[i]!==void 0?e.properties[i]:"";r!=="string"&&(f=JSON.stringify(f)),p.value=f,p.addEventListener("keydown",function(g){if(g.keyCode==27)u.close();else if(g.keyCode==13)d();else if(g.keyCode!=13){u.modified();return}g.preventDefault(),g.stopPropagation()})}p&&p.focus();const d=()=>{c(p.value)},c=f=>{s&&s.values&&s.values.constructor===Object&&s.values[f]!=null&&(f=s.values[f]),typeof e.properties[i]=="number"&&(f=Number(f)),(r=="array"||r=="object")&&(f=JSON.parse(f)),e.setProperty(i,f),n.onclose&&n.onclose(),u.close(),e.setDirtyCanvas(!0,!0)};var _=u.querySelector("button");return _.addEventListener("click",d),u}createDialog(e,i){var n={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0};i=Object.assign(n,i||{});var s=document.createElement("div");s.className="graphdialog",s.innerHTML=e,s.is_modified=!1;var r=this.canvas.getBoundingClientRect(),a=-20,l=-20;if(r&&(a-=r.left,l-=r.top),i.position?(a+=i.position[0],l+=i.position[1]):i.event?(a+=i.event.clientX,l+=i.event.clientY):(a+=this.canvas.width*.5,l+=this.canvas.height*.5),s.style.left=a+"px",s.style.top=l+"px",this.canvas.parentNode.appendChild(s),i.checkForInput){var o=s.querySelectorAll("input"),u=!1;o&&o.forEach(function(_){_.addEventListener("keydown",function(f){if(s.modified(),f.keyCode==27)s.close();else if(f.keyCode!=13)return;f.preventDefault(),f.stopPropagation()}),u||_.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};var p=null,d=0;s.addEventListener("mouseleave",function(_){d||(i.closeOnLeave||h.dialog_close_on_mouse_leave)&&!s.is_modified&&h.dialog_close_on_mouse_leave&&(p=setTimeout(s.close,h.dialog_close_on_mouse_leave_delay))}),s.addEventListener("mouseenter",function(_){(i.closeOnLeave||h.dialog_close_on_mouse_leave)&&p&&clearTimeout(p)});var c=s.querySelectorAll("select");return c&&c.forEach(function(_){_.addEventListener("click",function(f){d++}),_.addEventListener("blur",function(f){d=0}),_.addEventListener("change",function(f){d=-1})}),s}getCanvasMenuOptions(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions(this):(e=[{content:"Add Node",has_submenu:!0,callback:T.onMenuAdd},{content:"Add Group",callback:T.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&e.push(Z.SEPARATOR,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var i=this.getExtraMenuOptions(this,e);i&&(e=e.concat(i))}return e}getNodeMenuOptions(e){let i=[];e.getMenuOptions?i=e.getMenuOptions(this):(i=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:T.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:T.showMenuNodeOptionalOutputs},Z.SEPARATOR,{content:"Properties",has_submenu:!0,disabled:h.ignore_all_widget_events,callback:T.onShowMenuNodeProperties},Z.SEPARATOR,{content:"Title",value:{name:"title",type:"string"},callback:T.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:T.onMenuNodeMode}],e.resizable!==!1&&i.push({content:"Resize",callback:T.onMenuResizeNode}),i.push({content:"Collapse",callback:T.onMenuNodeCollapse},{content:"Pin",callback:T.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:T.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:T.onMenuNodeShapes},Z.SEPARATOR));const n=e.getOptionalSlots();if(n&&(n.inputs&&n.inputs.length>0&&typeof i[0]=="object"&&(i[0].disabled=!1),n.outputs&&n.outputs.length&&typeof i[1]=="object"&&(i[1].disabled=!1)),e.getExtraMenuOptions){var s=e.getExtraMenuOptions(this,i);s&&(s.push(Z.SEPARATOR),i=s.concat(i))}return e.clonable!==!1&&i.push({content:"Clone",callback:T.onMenuNodeClone}),i.push(Z.SEPARATOR,{content:"Remove",disabled:!(e.removable!==!1&&!e.block_delete),callback:T.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&(i=e.graph.onGetNodeMenuOptions(i,e)),i}getGroupMenuOptions(e){var i=[{content:"Title",value:{name:"title",type:"string"},callback:T.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:T.onMenuNodeColors},{content:"Font size",value:{name:"fontSize",type:"number"},callback:T.onShowPropertyEditor},Z.SEPARATOR,{content:"Remove",callback:T.onMenuNodeRemove}];return i}processContextMenu(e,i){var n=this,s=T.active_canvas,r=s.getCanvasWindow();let a=i,l=null;var o={event:a,callback:c,extra:e};e&&(o.title=e.type);var u=null;if(e&&(u=e.getSlotInPosition(a.canvasX,a.canvasY),T.active_node=e),u){if(l=[],e.getSlotMenuOptions)l=e.getSlotMenuOptions(u);else{u&&u.output&&u.output.links&&u.output.links.length&&l.push({content:"Disconnect Links",slot:u});var p=u.input||u.output;p.removable&&l.push(p.locked?"Cannot remove":{content:"Remove Slot",slot:u}),p.nameLocked||l.push({content:"Rename Slot",slot:u})}o.title=(u.input?u.input.type:u.output.type)||"*",u.input&&u.input.type==k.ACTION&&(o.title="Action"),u.output&&u.output.type==k.EVENT&&(o.title="Event")}else if(e)l=this.getNodeMenuOptions(e);else{l=this.getCanvasMenuOptions();var d=this.graph.getGroupOnPos(a.canvasX,a.canvasY);d&&l.push(Z.SEPARATOR,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:d,options:this.getGroupMenuOptions(d)}})}if(!l)return;new Y(l,o,r);function c(_,f,g){if(_){if(_.content=="Remove Slot"){var m=_.slot;e.graph.beforeChange(),m.input?e.removeInput(m.slot):m.output&&e.removeOutput(m.slot),e.graph.afterChange();return}else if(_.content=="Disconnect Links"){var m=_.slot;e.graph.beforeChange(),m.output?e.disconnectOutput(m.slot):m.input&&e.disconnectInput(m.slot),e.graph.afterChange();return}else if(_.content=="Rename Slot"){var m=_.slot,y=m.input?e.getInputInfo(m.slot):e.getOutputInfo(m.slot),E=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",f),v=E.querySelector("input");v&&y&&(v.value=y.label||"");var b=function(){e.graph.beforeChange(),v.value&&(y&&(y.label=v.value),n.setDirty(!0)),E.close(),e.graph.afterChange()};E.querySelector("button").addEventListener("click",b),v.addEventListener("keydown",function(O){if(E.is_modified=!0,O.keyCode==27)E.close();else if(O.keyCode==13)b();else if(O.keyCode!=13&&O.target instanceof Element&&O.target.localName!="textarea")return;O.preventDefault(),O.stopPropagation()}),v.focus()}}}}createPanel(e,i={}){var n=i.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML=`
<div class='dialog-header'><span class='dialog-title'></span></div>
<div class='dialog-content'></div>
<div style='display:none;' class='dialog-alt-content'></div>
<div class='dialog-footer'></div>`,s.header=s.querySelector(".dialog-header"),i.width&&(s.style.width=i.width+(i.width.constructor===Number?"px":"")),i.height&&(s.style.height=i.height+(i.height.constructor===Number?"px":"")),i.closable){var r=document.createElement("span");r.innerHTML="&#10005;",r.classList.add("close"),r.addEventListener("click",function(){s.close()}),s.header.appendChild(r)}return i.onOpen&&(s.onOpen=i.onOpen),i.onClose&&(s.onClose=i.onClose),s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=e,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){s.onClose&&typeof s.onClose=="function"&&s.onClose(),s.parentNode&&s.parentNode.removeChild(s),this.parentNode&&this.parentNode.removeChild(this)},s.toggleAltContent=function(a=!1){if(typeof a<"u")var l=a?"block":"none",o=a?"none":"block";else var l=s.alt_content.style.display!="block"?"block":"none",o=s.alt_content.style.display!="block"?"none":"block";s.alt_content.style.display=l,s.content.style.display=o},s.toggleFooterVisibility=function(a=!1){if(typeof a<"u")var l=a?"block":"none";else var l=s.footer.style.display!="block"?"block":"none";s.footer.style.display=l},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(a,l,o){var u=document.createElement("div");return l&&(u.className=l),u.innerHTML=a,o?s.footer.appendChild(u):s.content.appendChild(u),u},s.addButton=function(a,l,o){var u=document.createElement("button");return u.innerText=a,u.options=o,u.classList.add("btn"),u.addEventListener("click",l),s.footer.appendChild(u),u},s.addSeparator=function(){var a=document.createElement("div");return a.className="separator",s.content.appendChild(a),a},s.addWidget=function(a,l,o,u={},p){var d=String(o);a=a.toLowerCase(),a=="number"&&(d=o.toFixed(3));var c=document.createElement("div");c.className="property",c.innerHTML="<span class='property_name'></span><span class='property_value'></span>";let _=c.querySelector(".property_name");_.innerText=u.label||l;var f=c.querySelector(".property_value");if(f.innerText=d,c.dataset.property=l,c.dataset.type=u.type||a,c.options=u,c.value=o,a=="code")c.addEventListener("click",function(m){s.inner_showCodePad(this.dataset.property)});else if(a=="boolean")c.classList.add("boolean"),o&&c.classList.add("bool-on"),c.addEventListener("click",function(){var m=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on");const y=this.querySelector(".property_value");y.innerText=this.value?"true":"false",g(m,this.value)});else if(a=="string"||a=="number")f.setAttribute("contenteditable","true"),f.addEventListener("keydown",function(m){m.code=="Enter"&&(a!="string"||!m.shiftKey)&&(m.preventDefault(),this.blur())}),f.addEventListener("blur",function(){let m=this.innerText;const y=this.parentNode;var E=y.dataset.property,v=y.dataset.type;v=="number"&&(m=Number(m)),g(E,m)});else if((a=="enum"||a=="combo")&&"values"in u){var d=T.getPropertyPrintableValue(o,u.values);f.innerText=d,f.addEventListener("click",function(y){let E=u.values||[];typeof E=="function"&&(console.error("Values by callback not supported in panel.addWidget!",E),E=[]);var b=this.parentNode.dataset.property,C=this;let O=Array.from(E).map(B=>({content:B}));new Y(O,{event:y,className:"dark",callback:G},n);function G(B,z,F){return C.innerText=B.content,g(b,B.content),!1}})}s.content.appendChild(c);function g(m,y){u.callback&&u.callback(m,y,u),p&&p(m,y,u)}return c},s.onOpen&&typeof s.onOpen=="function"&&s.onOpen(),s}checkPanels(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),i=0;i<e.length;++i){var n=e[i];n.node&&(!n.node.graph||n.graph!=this.graph)&&n.close()}}closePanels(){var e=document.querySelector("#node-panel");e&&e.close();var e=document.querySelector("#option-panel");e&&e.close()}}N.onShowPropertyEditor=function(t,e,i,n,s){var r=t.value,a=r.name,l=s[a],o=document.createElement("div");o.is_modified=!1,o.className="graphdialog",o.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",o.close=function(){o.parentNode&&o.parentNode.removeChild(o)};var u=o.querySelector(".name");u.innerText=a;var p=o.querySelector(".value");p&&(p.value=l,p.addEventListener("blur",function(b){this.focus()}),p.addEventListener("keydown",function(b){if(o.is_modified=!0,b.keyCode==27)o.close();else if(b.keyCode==13)m();else if(b.keyCode!=13&&b.target instanceof Element&&b.target.localName!="textarea")return;b.preventDefault(),b.stopPropagation()}));var d=T.active_canvas,c=d.canvas,_=c.getBoundingClientRect(),f=-20,g=-20;_&&(f-=_.left,g-=_.top),i?(o.style.left=i.clientX+f+"px",o.style.top=i.clientY+g+"px"):(o.style.left=c.width*.5+f+"px",o.style.top=c.height*.5+g+"px");const m=()=>{p&&y(p.value)},y=b=>{r.type=="number"?b=Number(b):r.type=="boolean"&&(b=!!b);const C=s[a];s[a]=b,s.onJSPropertyChanged&&s.onJSPropertyChanged(a,b,C)===!1&&(s[a]=C),o.parentNode&&o.parentNode.removeChild(o),s.setDirtyCanvas(!0,!0)};var E=o.querySelector("button");E.addEventListener("click",m),c.parentNode.appendChild(o),p&&p.focus();var v=null;o.addEventListener("mouseleave",function(b){h.dialog_close_on_mouse_leave&&!o.is_modified&&h.dialog_close_on_mouse_leave&&(v=setTimeout(o.close,h.dialog_close_on_mouse_leave_delay))}),o.addEventListener("mouseenter",function(b){h.dialog_close_on_mouse_leave&&v&&clearTimeout(v)})},N.onGroupAdd=function(t,e,i,n){var s=T.active_canvas;s.getCanvasWindow();var r=new le;r.pos=s.convertEventToCanvasOffset(i),s.graph.addGroup(r)},N.onMenuAdd=function(t,e,i,n,s){var r=T.active_canvas,a=r.getCanvasWindow(),l=r.graph;if(!l)return;function o(u,p){var d=h.getNodeTypesCategories(r.filter||l.filter).filter(function(f){return f.startsWith(u)}),c=[];d.map(function(f){if(f){var g=new RegExp("^("+u+")"),m=f.replace(g,"").split("/")[0],y=u===""?m+"/":u+m+"/",E=m;E.indexOf("::")!=-1&&(E=E.split("::")[1]);var v=c.findIndex(function(b){return b.value===y});v===-1&&c.push({value:y,content:E,has_submenu:!0,callback:function(b,C,O,G){o(b.value,G)}})}});var _=h.getNodeTypesInCategory(u.slice(0,-1),r.filter||l.filter);_.map(function(f){if(!f.skip_list){var g={value:f.class,content:f.title,has_submenu:!1,callback:function(m,y,E,v){var b=v.getFirstEvent();r.graph.beforeChange();var C=h.createNode(m.value);C&&(C.pos=r.convertEventToCanvasOffset(b),r.graph.add(C)),s&&s(C),r.graph.afterChange()}};c.push(g)}}),new Y(c,{event:i,parentMenu:p},a)}return o("",n),!1},N.showMenuNodeOptionalInputs=function(t,e,i,n,s){if(!s)return;var r=this,a=T.active_canvas,l=a.getCanvasWindow();let o=s.getOptionalSlots().inputs,u=[];if(o)for(let _=0;_<o.length;_++){let f=o[_];if(!f){u.push(Z.SEPARATOR);continue}let{name:g,type:m,options:y}=f;y||(y={}),y.label&&(g=y.label),y.removable=!0;var p={content:g,value:f};m==k.ACTION&&(p.className="event"),u.push(p)}if(s.onMenuNodeInputs){var d=s.onMenuNodeInputs(u);d&&(u=d)}if(!u.length){console.log("no input entries");return}new Y(u,{event:i,callback:c,parentMenu:n,node:s},l);function c(_,f,g,m){if(s&&(_.callback&&_.callback.call(r,s,_,g,m),_.value)){let y=_.value;s.graph.beforeChange(),s.addInput(y.name,y.type,y.options),s.onNodeOptionalInputAdd&&s.onNodeOptionalInputAdd(_.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange()}}return!1},N.showMenuNodeOptionalOutputs=function(t,e,i,n,s){if(!s)return;var r=this,a=T.active_canvas,l=a.getCanvasWindow(),o=s.getOptionalSlots().outputs,u=[];if(o)for(var p=0;p<o.length;p++){var d=o[p];if(!d){u.push(Z.SEPARATOR);continue}let{name:g,type:m,options:y}=d;if(!(s.flags&&s.flags.skip_repeated_outputs&&s.findOutputSlotIndexByName(d[0])!=-1)){y||(y={}),y.label&&(g=y.label),y.removable=!0;var c={content:g,value:[g,m,y]};m==k.EVENT&&(c.className="event"),u.push(c)}}if(this.onMenuNodeOutputs&&(u=this.onMenuNodeOutputs(u)),h.do_add_triggers_slots&&s.findOutputSlotIndexByName("onExecuted")==-1&&u.push({content:"On Executed",value:["onExecuted",k.EVENT,{nameLocked:!0}],className:"event"}),s.onMenuNodeOutputs){var _=s.onMenuNodeOutputs(u);_&&(u=_)}if(!u.length)return;let f=function(g,m,y,E){if(s&&(g.callback&&g.callback.call(r,s,g,y,E),!!g.value)){var v=g.value[1];if(v&&(v.constructor===Object||v.constructor===Array)){var b=[];for(var C in v)b.push({content:C,value:v[C]});return new Y(b,{event:y,callback:f,parentMenu:n,node:s}),!1}else{const O=g.value;s.graph.beforeChange(),s.addOutput(O.name,O.type,O.options),s.onNodeOptionalOutputAdd&&s.onNodeOptionalOutputAdd(g.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange()}}};return new Y(u,{event:i,callback:f,parentMenu:n,node:s},l),!1},N.onMenuResizeNode=function(t,e,i,n,s){if(s){var r=function(o){o.size=o.computeSize(),o.onResize&&o.onResize(o.size)},a=T.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(s);else for(var l in a.selected_nodes)r(a.selected_nodes[l]);s.setDirtyCanvas(!0,!0)}},N.onShowMenuNodeProperties=function(t,e,i,n,s){if(!s||!s.properties)return;var r=T.active_canvas,a=r.getCanvasWindow(),l=[];for(var o in s.properties){var u=s.properties[o]!==void 0?s.properties[o]:" ";typeof u=="object"&&(u=JSON.stringify(u));var p=s.getPropertyInfo(o);(p.type=="enum"||p.type=="combo")&&(u=T.getPropertyPrintableValue(u,p.values)),u=T.decodeHTML(u),l.push({content:"<span class='property_name'>"+(p.label?p.label:o)+"</span><span class='property_value'>"+u+"</span>",value:o})}if(!l.length)return;new Y(l,{event:i,callback:d,parentMenu:n,allow_html:!0,node:s},a);function d(c,_,f,g){if(s){var m=this.getBoundingClientRect();r.showEditPropertyValue(s,c.value,{position:[m.left,m.top]})}}return!1},N.onResizeNode=function(t,e,i,n,s){s&&(s.size=s.computeSize(),s.setDirtyCanvas(!0,!0))},N.onMenuNodeCollapse=function(t,e,i,n,s){s.graph.beforeChange();var r=function(o){o.collapse()},a=T.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(s);else for(var l in a.selected_nodes)r(a.selected_nodes[l]);s.graph.afterChange()},N.onMenuNodePin=function(t,e,i,n,s){s.pin()},N.onMenuNodeMode=function(t,e,i,n,s){let r=Array.from(ne).map(l=>({content:l}));new Y(r,{event:i,callback:a,parentMenu:n,node:s});function a(l){if(s){var o=Object.values(ne).indexOf(l.content),u=function(c){o>=j.ALWAYS&&ne[o]?c.changeMode(o):(console.warn("unexpected mode: "+l),c.changeMode(j.ALWAYS))},p=T.active_canvas;if(!p.selected_nodes||Object.keys(p.selected_nodes).length<=1)u(s);else for(var d in p.selected_nodes)u(p.selected_nodes[d])}}return!1},N.onMenuNodeColors=function(t,e,i,n,s){if(!s)throw"no node for color";var r=[];r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(let o in T.node_colors){var a=T.node_colors[o];let u={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+a.color+"; background-color:"+a.bgColor+"'>"+o+"</span>"};r.push(u)}new Y(r,{event:i,callback:l,parentMenu:n,node:s,allow_html:!0});function l(o){if(s){var u=o.value?T.node_colors[o.value]:null,p=function(_){u?_ instanceof le?_.color=u.groupcolor:(_.color=u.color,_.bgColor=u.bgColor):(delete _.color,_ instanceof te&&delete _.bgColor)},d=T.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)p(s);else for(var c in d.selected_nodes)p(d.selected_nodes[c]);s.setDirtyCanvas(!0,!0)}}return!1},N.onMenuNodeShapes=function(t,e,i,n,s){if(!s)throw"no node passed";const r=Array.from(ve).map(l=>({content:l}));new Y(r,{event:i,callback:a,parentMenu:n,node:s});function a(l){if(s){s.graph.beforeChange();var o=function(d){d.shape=ve.indexOf(l.content)},u=T.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)o(s);else for(var p in u.selected_nodes)o(u.selected_nodes[p]);s.graph.afterChange(),s.setDirtyCanvas(!0)}}return!1},N.onMenuNodeRemove=function(t,e,i,n,s){if(!s)throw"no node passed";var r=s.graph;r.beforeChange();var a=function(u){u.removable!==!1&&r.remove(u)},l=T.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)a(s);else for(var o in l.selected_nodes)a(l.selected_nodes[o]);r.afterChange(),s.setDirtyCanvas(!0,!0)},N.onMenuNodeToSubgraph=function(t,e,i,n,s){var r=s.graph,a=T.active_canvas;if(a){var l=Object.values(a.selected_nodes||{});l.length||(l=[s]);var o=h.createNode("graph/subgraph");o.pos=s.pos.concat(),r.add(o),o.buildFromNodes(l),a.deselectAllNodes(),s.setDirtyCanvas(!0,!0)}},N.onMenuNodeClone=function(t,e,i,n,s){s.graph.beforeChange();var r={},a=function(u){if(u.clonable!=!1){var p=u.clone();p&&(p.pos=[u.pos[0]+5,u.pos[1]+5],u.graph.add(p),r[p.id]=p)}},l=T.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)a(s);else for(var o in l.selected_nodes)a(l.selected_nodes[o]);Object.keys(r).length&&l.selectNodes(Object.values(r)),s.graph.afterChange(),s.setDirtyCanvas(!0,!0)};const Oe=function(t,e,i){return e>t?e:i<t?i:t},de=class{constructor(t,e,i={}){this.node_panel=null,this.options_panel=null,this.render_time=0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_reconnect_links=!0,this.allow_searchbox=!0,this.always_render_background=!1,this.background_image=de.DEFAULT_BACKGROUND_IMAGE,this.block_click=!1,this.clear_background=!0,this.connecting_pos=null,this.connecting_slot=null,this.connecting_input=null,this.connecting_output=null,this.connections_width=3,this.current_node=null,this.drag_mode=!1,this.dragging_rectangle=null,this.ds=new Ce,this.editor_alpha=1,this.filter=null,this.highquality_render=!0,this.skip_events=!1,this.last_mouse_position=[0,0],this.last_click_position=[0,0],this.last_mouse_dragging=!1,this.links_render_mode=ae.SPLINE_LINK,this.live_mode=!1,this.mouse=[0,0],this.graph_mouse=[0,0],this.node_widget=null,this.maxZoom=null,this.minZoom=null,this.multi_select=!1,this.over_link_center=null,this.pause_rendering=!1,this.read_only=!1,this.render_canvas_border=!0,this.render_collapsed_slots=!0,this.render_connection_arrows=!1,this.render_connections_border=!0,this.render_connections_shadows=!1,this.render_curved_connections=!1,this.render_execution_order=!1,this.render_link_tooltip=!0,this.render_only_selected=!0,this.render_shadows=!0,this.render_title_colored=!0,this.round_radius=8,this.set_canvas_dirty_on_mouse_event=!0,this.show_info=!0,this.use_gradients=!1,this.visible_links=[],this.zoom_modify_alpha=!0,this.pointer_is_down=!1,this.pointer_is_double=!1,this._highlight_input=null,this._highlight_input_slot=null,this._highlight_output=null,this._graph_stack=null,this._bg_img=null,this._pattern=null,this._pattern_img=null,this.search_box=null,this.prompt_box=null,this._events_binded=!1,this.resizing_node=null,typeof t=="string"&&(t=document.querySelector(t)),this.skip_events=i.skip_events||!1,this.title_text_font=""+h.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+h.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=h.NODE_TITLE_COLOR,this.default_link_color=h.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.canvas_mouse=this.graph_mouse,this.visible_area=this.ds.visible_area,this.viewport=i.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,i.skip_events),this.clear(),i.skip_render||this.startRendering(),this.autoresize=i.autoresize}static getFileExtension(t){var e=t.indexOf("?");e!=-1&&(t=t.substr(0,e));var i=t.lastIndexOf(".");return i==-1?"":t.substr(i+1).toLowerCase()}static decodeHTML(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML}static getPropertyPrintableValue(t,e){if(!e||e.constructor===Array)return String(t);if(e.constructor===Object){var i="";for(var n in e)if(e[n]==t){i=n;break}return String(t)+" ("+i+")"}}get scale(){return this.ds.scale}set scale(t){this.ds.scale=t}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.onClear&&this.onClear()}setGraph(t,e=!1){if(this.graph!=t){if(e||this.clear(),!t&&this.graph){this.graph.detachCanvas(this);return}t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}openSubgraph(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(!(!this._graph_stack||this._graph_stack.length==0)){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1}}setCanvas(t,e=!1){if(t&&typeof t=="string"&&(t=document.getElementById(t),!t))throw"Error creating LiteGraph canvas: Canvas not found";if(t=t,t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,!!t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabIndex=1,this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),t.getContext==null)throw t.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName:"This browser doesn't support Canvas";e||this.bindEvents(),this.adjustCanvasForHiDPI()}}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var t=this.canvas,e=this.getCanvasWindow(),i=e.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),h.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),h.pointerListenerAdd(t,"up",this._mouseup_callback,!0),h.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),i.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}h.debug&&console.log("pointerevents: unbindEvents");var t=this.getCanvasWindow(),e=t.document;h.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),h.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),h.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),e.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}enableWebGL(){}setDirty(t=!1,e=!1){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView}adjustCanvasForHiDPI(t){if(t||(t=window.devicePixelRatio),t==1||!this.canvas.parentNode)return;const e=this.canvas.parentNode.getBoundingClientRect(),{width:i,height:n}=e;this.canvas.width=i*t,this.canvas.height=n*t,this.canvas.style.width=i+"px",this.canvas.style.height=n+"px",this.canvas.getContext("2d").scale(t,t)}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}createDefaultNodeForSlot(t,e={position:[0,0],posAdd:[0,0],posSizeFix:[0,0]}){var i=this,n=e.nodeFrom&&e.slotFrom!==null,s=!n&&e.nodeTo&&e.slotTo!==null;if(!n&&!s)return console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo),!1;if(!t)return console.warn("No type to createDefaultNodeForSlot"),!1;var r=n?e.nodeFrom:e.nodeTo,a=n?e.slotFrom:e.slotTo,l=null;switch(typeof a){case"string":l=n?r.findOutputSlotIndexByName(a):r.findInputSlotIndexByName(a),a=n?r.outputs[a]:r.inputs[a];break;case"object":l=n?r.findOutputSlotIndexByName(a.name):r.findInputSlotIndexByName(a.name);break;case"number":l=a,a=n?r.outputs[a]:r.inputs[a];break;case"undefined":default:return console.warn("Cant get slot information "+a),!1}a=a,(!a||!l)&&console.warn("createDefaultNodeForSlot bad slotX "+a+" "+l);var o=a.type==k.EVENT?"_event_":a.type,u=n?h.slot_types_default_out:h.slot_types_default_in;const p=u[o];if(u&&p){a.link!==null||a.links&&a.links.length>0;let g=null;if(typeof p=="object"&&Array.isArray(p)){for(var d of p)if(t==u[o][d]||t=="AUTO"){g=u[o][d],h.debug&&console.log("opts.nodeType == slotTypesDefault[fromSlotType][typeX] :: "+t);break}}else(t==p||t=="AUTO")&&(g=p);if(g){var c=null;typeof g=="object"&&g.node&&(c=g,g=g.node);var _=h.createNode(g);if(_){if(c){if(c.properties)for(var f in c.properties)_.addProperty(f,c.properties[f]);if(c.inputs){_.inputs=[];for(var f in c.inputs)_.addOutput(c.inputs[f][0],c.inputs[f][1])}if(c.outputs){_.outputs=[];for(var f in c.outputs)_.addOutput(c.outputs[f][0],c.outputs[f][1])}c.title&&(_.title=c.title),c.json&&_.configure(c.json)}return i.graph.add(_),_.pos=[e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*_.size[0]:0),e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*_.size[1]:0)],n?e.nodeFrom.connectByTypeInput(l,_,o):e.nodeTo.connectByTypeOutput(l,_,o),n&&s&&console.debug("connecting in between"),!0}else console.log("failed creating "+g)}}return!1}isOverNodeBox(t,e,i){var n=h.NODE_TITLE_HEIGHT;return!!h.isInsideRectangle(e,i,t.pos[0]+2,t.pos[1]+2-n,n-4,n-4)}isOverNodeInput(t,e,i,n){if(t.inputs)for(var s=0,r=t.inputs.length;s<r;++s){var a=t.getConnectionPos(!0,s),l=!1;if(t.horizontal?l=h.isInsideRectangle(e,i,a[0]-5,a[1]-10,10,20):l=h.isInsideRectangle(e,i,a[0]-10,a[1]-5,40,10),l)return n&&(n[0]=a[0],n[1]=a[1]),s}return-1}isOverNodeOutput(t,e,i,n){if(t.outputs)for(var s=0,r=t.outputs.length;s<r;++s){t.outputs[s];var a=t.getConnectionPos(!1,s),l=!1;if(t.horizontal?l=h.isInsideRectangle(e,i,a[0]-5,a[1]-10,10,20):l=h.isInsideRectangle(e,i,a[0]-10,a[1]-5,40,10),l)return n&&(n[0]=a[0],n[1]=a[1]),s}return-1}processKey(t){if(this.graph){var e=!1;if(h.debug&&console.log("processKey",t),!(t.target instanceof Element&&t.target.localName=="input")){if(t.type=="keydown"){if(t.keyCode==32&&(this.dragging_canvas=!0,e=!0),t.keyCode==27&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),t.keyCode==65&&t.ctrlKey&&(this.selectNodes(),e=!0),t.code=="KeyC"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),e=!0),t.code=="KeyV"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.pasteFromClipboard(),(t.keyCode==46||t.keyCode==8)&&t.target instanceof Element&&t.target.localName!="input"&&t.target.localName!="textarea"&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if(t.type=="keyup"&&(t.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);if(this.graph.change(),e)return t.preventDefault(),t.stopImmediatePropagation(),!1}}}copyToClipboard(){var t={nodes:[],links:[]},e=0,i=[];for(var n in this.selected_nodes){var s=this.selected_nodes[n];s._relative_id=e,i.push(s),e+=1}for(let u=0;u<i.length;++u){let p=i[u],d=p.clone();if(!d){console.warn("node type not found: "+p.type);continue}if(t.nodes.push(d.serialize()),p.inputs&&p.inputs.length)for(var r=0;r<p.inputs.length;++r){var a=p.inputs[r];if(!(!a||a.link==null)){var l=this.graph.links[a.link];if(l){var o=this.graph.getNodeById(l.origin_id);!o||!this.selected_nodes[o.id]||t.links.push([o._relative_id,l.origin_slot,p._relative_id,l.target_slot])}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))}pasteFromClipboard(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var e=JSON.parse(t),i=null,n=null,s=0;s<e.nodes.length;++s)i?(i[0]>e.nodes[s].pos[0]&&(i[0]=e.nodes[s].pos[0],n[0]=s),i[1]>e.nodes[s].pos[1]&&(i[1]=e.nodes[s].pos[1],n[1]=s)):(i=[e.nodes[s].pos[0],e.nodes[s].pos[1]],n=[s,s]);for(var r=[],s=0;s<e.nodes.length;++s){var a=e.nodes[s],l=h.createNode(a.type);l&&(l.configure(a),l.pos[0]+=this.graph_mouse[0]-i[0],l.pos[1]+=this.graph_mouse[1]-i[1],this.graph.add(l,{doProcessChange:!1}),r.push(l))}for(var s=0;s<e.links.length;++s){var o=e.links[s],u=r[o[0]],p=r[o[2]];u&&p?u.connect(o[1],p,o[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(r),this.graph.afterChange()}}processDrop(t){let e=t;e.preventDefault(),this.adjustMouseEvent(e);var i=e.clientX,n=e.clientY,s=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(s){var r=[e.canvasX,e.canvasY],a=this.graph?this.graph.getNodeOnPos(r[0],r[1]):null;if(!a){var l=null;this.onDropItem&&(l=this.onDropItem(e)),l||this.checkDropItem(e);return}if(a.onDropFile||a.onDropData){var o=e.dataTransfer.files;if(o&&o.length)for(var u=0;u<o.length;u++){var p=e.dataTransfer.files[0],d=p.name;if(de.getFileExtension(d),a.onDropFile&&a.onDropFile(p),a.onDropData){var c=new FileReader;c.onload=function(f){var g=f.target.result;a.onDropData(g,d,p)};var _=p.type.split("/")[0];_=="text"||_==""?c.readAsText(p):_=="image"?c.readAsDataURL(p):c.readAsArrayBuffer(p)}}}return!!(a.onDropItem&&a.onDropItem(e)||this.onDropItem&&this.onDropItem(e))}}checkDropItem(t){let e=t;if(e.dataTransfer.files.length){var i=e.dataTransfer.files[0],n=de.getFileExtension(i.name).toLowerCase(),s=h.node_types_by_file_extension[n];if(s){this.graph.beforeChange();var r=h.createNode(s.type);r.pos=[e.canvasX,e.canvasY],this.graph.add(r),r.onDropFile&&r.onDropFile(i),this.graph.afterChange()}}}processNodeDblClicked(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)}processNodeSelected(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)}selectNode(t,e=!1){t==null?this.deselectAllNodes():this.selectNodes([t],e)}selectNodes(t,e=!1){e||this.deselectAllNodes(),t=t||this.graph._nodes,typeof t=="string"&&(t=[t]);for(var i in t){var n=t[i];if(n.is_selected){this.deselectNode(n);continue}if(!n.is_selected&&n.onSelected&&n.onSelected(),n.is_selected=!0,this.selected_nodes[n.id]=n,n.inputs)for(var s=0;s<n.inputs.length;++s)this.highlighted_links[n.inputs[s].link]=!0;if(n.outputs)for(var s=0;s<n.outputs.length;++s){var r=n.outputs[s];if(r.links)for(var a=0;a<r.links.length;++a)this.highlighted_links[r.links[a]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deselectNode(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(var e=0;e<t.outputs.length;++e){var i=t.outputs[e];if(i.links)for(var n=0;n<i.links.length;++n)delete this.highlighted_links[i.links[n]]}}}deselectAllNodes(){if(this.graph){for(var t=this.graph._nodes,e=0,i=t.length;e<i;++e){var n=t[e];n.is_selected&&(n.onDeselected&&n.onDeselected(),n.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(n))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}}deleteSelectedNodes(){this.graph.beforeChange();for(var t in this.selected_nodes){var e=this.selected_nodes[t];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&h.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var i=e.graph.links[e.inputs[0].link],n=e.graph.links[e.outputs[0].links[0]],s=e.getInputNode(0),r=e.getOutputNodes(0)[0];s&&r&&s.connect(i.origin_slot,r,n.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(t){this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(t){let e=t;var i=0,n=0;if(this.canvas){var s=this.canvas.getBoundingClientRect();i=e.clientX-s.left,n=e.clientY-s.top}else i=e.clientX,n=e.clientY;this.last_mouse_position[0]=i,this.last_mouse_position[1]=n,e.canvasX=i/this.ds.scale-this.ds.offset[0],e.canvasY=n/this.ds.scale-this.ds.offset[1]}processNodeWidgets(t,e,i,n){if(!t.widgets||!t.widgets.length||h.ignore_all_widget_events)return null;for(var s=e[0]-t.pos[0],r=e[1]-t.pos[1],a=t.size[0],l=this,o=this.getCanvasWindow(),u=0;u<t.widgets.length;++u){var p=t.widgets[u];if(!(!p||p.disabled)){var d=p.computeSize?p.computeSize(a)[1]:h.NODE_WIDGET_HEIGHT,c=p.width||a;if(!(p!=n&&(s<6||s>c-12||r<p.last_y||r>p.last_y+d||p.last_y===void 0))){var _=p.value;switch(p.type){case"button":i.type===h.pointerevents_method+"down"&&(p.callback&&setTimeout(function(){p.callback(p,l,t,e,i)},20),p.clicked=!0,this.dirty_canvas=!0);break;case"slider":p.options.max-p.options.min;var f=Oe((s-15)/(c-30),0,1);p.value=p.options.min+(p.options.max-p.options.min)*f,p.callback&&setTimeout(function(){b(p,p.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":var _=p.value;if(i.type==h.pointerevents_method+"move"&&p.type=="number")i.deltaX&&(p.value+=i.deltaX*.1*(p.options.step||1)),p.options.min!=null&&p.value<p.options.min&&(p.value=p.options.min),p.options.max!=null&&p.value>p.options.max&&(p.value=p.options.max);else if(i.type==h.pointerevents_method+"down"){var g=p.options.values;if(g&&typeof g=="function"){let O=p.options.values;g=O(p,t)}var m=null;p.type!="number"&&(m=Array.isArray(g)?g:Object.keys(g));var y=s<40?-1:s>c-40?1:0;if(p.type=="number")p.value+=y*(p.options.step||.1),p.options.min!=null&&p.value<p.options.min&&(p.value=p.options.min),p.options.max!=null&&p.value>p.options.max&&(p.value=p.options.max);else if(y){var E=-1;this.last_mouseclick=0,g.constructor===Object?E=m.indexOf(String(p.value))+y:E=m.indexOf(p.value)+y,E>=m.length&&(E=m.length-1),E<0&&(E=0),Array.isArray(g)?p.value=g[E]:p.value=E}else{let O=function(B,z,F){let R=B.content;return g!=m&&(R=v.indexOf(R)),this.value=B,b(this,B),l.dirty_canvas=!0,!1};var v=g!=m?Object.values(g):g;let G=Array.from(v).map(B=>({content:B}));new Y(G,{scale:Math.max(1,this.ds.scale),event:i,className:"dark",callback:O.bind(p)},o)}}else if(i.type==h.pointerevents_method+"up"&&p.type=="number"){var y=s<40?-1:s>c-40?1:0;i.click_time<200&&y==0&&this.prompt("Value",p.value,function(G){this.value=Number(G),b(this,this.value)}.bind(p),i)}_!=p.value&&setTimeout(function(){b(this,this.value)}.bind(p),20),this.dirty_canvas=!0;break;case"toggle":i.type==h.pointerevents_method+"down"&&(p.value=!p.value,setTimeout(function(){b(p,p.value)},20));break;case"string":case"text":i.type==h.pointerevents_method+"down"&&this.prompt("Value",p.value,function(O){this.value=O,b(this,O)}.bind(p),i,p.options?p.options.multiline:!1);break;default:p.mouse&&(this.dirty_canvas=p.mouse(i,[s,r],t));break}return _!=p.value&&(t.onWidgetChanged&&t.onWidgetChanged(p,_),t.graph._version++),p}}}function b(C,O){C.value=O,C.options&&C.options.property&&t.properties[C.options.property]!==void 0&&t.setProperty(C.options.property,O),C.callback&&C.callback(C.value,l,t,e,i)}return null}adjustNodesSize(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)}resize(t,e){if(!t&&!e){var i=this.canvas.parentNode;t=i.offsetWidth,e=i.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.adjustCanvasForHiDPI(),this.setDirty(!0,!0))}isAreaClicked(t,e,i,n,s){var r=this.mouse;h.isInsideRectangle(r[0],r[1],t,e,i,n),r=this.last_click_position;var a=r&&h.isInsideRectangle(r[0],r[1],t,e,i,n),l=a&&!this.block_click;return a&&s&&this.blockClick(),l}switchLiveMode(t){if(!t){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var e=this,i=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var n=setInterval(function(){e.editor_alpha*=i,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,i<1&&e.editor_alpha<.01&&(clearInterval(n),i<1&&(e.live_mode=!0)),i>1&&e.editor_alpha>.99&&(clearInterval(n),e.editor_alpha=1)},1)}onNodeSelectionChange(){}touchHandler(t){}convertOffsetToCanvas(t){return this.ds.convertOffsetToCanvas(t)}convertCanvasToOffset(t,e=[0,0]){return this.ds.convertCanvasToOffset(t,e)}convertEventToCanvasOffset(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])}getCanvasMenuOptions(){return N.prototype.getCanvasMenuOptions.apply(this,arguments)}getNodeMenuOptions(t){return N.prototype.getNodeMenuOptions.apply(this,arguments)}getGroupMenuOptions(t){return N.prototype.getGroupMenuOptions.apply(this,arguments)}checkPanels(){N.prototype.checkPanels.apply(this,arguments)}closePanels(){N.prototype.closePanels.apply(this,arguments)}createDialog(t,e){return N.prototype.createDialog.apply(this,arguments)}createPanel(t,e={}){return N.prototype.createPanel.apply(this,arguments)}showSearchBox(t,e={}){return N.prototype.showSearchBox.apply(this,arguments)}prompt(t="",e,i,n,s=!1){return N.prototype.prompt.apply(this,arguments)}showConnectionMenu(t={}){return N.prototype.showConnectionMenu.apply(this,arguments)}showLinkMenu(t,e){return N.prototype.showLinkMenu.apply(this,arguments)}showEditPropertyValue(t,e,i){return N.prototype.showEditPropertyValue.apply(this,arguments)}showShowNodePanel(t){N.prototype.showShowNodePanel.apply(this,arguments)}showSubgraphPropertiesDialog(){return N.prototype.showSubgraphPropertiesDialog.apply(this,arguments)}showSubgraphPropertiesDialogRight(t){return N.prototype.showSubgraphPropertiesDialogRight.apply(this,arguments)}processContextMenu(t,e){N.prototype.processContextMenu.apply(this,arguments)}processMouseMove(t){return oe.prototype.processMouseMove.apply(this,arguments)}processMouseDown(t){return oe.prototype.processMouseDown.apply(this,arguments)}processMouseUp(t){return oe.prototype.processMouseUp.apply(this,arguments)}processMouseWheel(t){return oe.prototype.processMouseWheel.apply(this,arguments)}setZoom(t,e){P.prototype.setZoom.apply(this,arguments)}bringToFront(t){P.prototype.bringToFront.apply(this,arguments)}sendToBack(t){P.prototype.sendToBack.apply(this,arguments)}computeVisibleNodes(t,e=[]){return P.prototype.computeVisibleNodes.apply(this,arguments)}draw(t=!1,e=!1){P.prototype.draw.apply(this,arguments)}drawFrontCanvas(){P.prototype.drawFrontCanvas.apply(this,arguments)}drawSubgraphPanel(t){P.prototype.drawSubgraphPanel.apply(this,arguments)}drawSubgraphPanelLeft(t,e,i){P.prototype.drawSubgraphPanelLeft.apply(this,arguments)}drawSubgraphPanelRight(t,e,i){P.prototype.drawSubgraphPanelRight.apply(this,arguments)}drawButton(t,e,i,n,s,r=h.NODE_DEFAULT_COLOR,a="#555",l=h.NODE_TEXT_COLOR){return P.prototype.drawButton.apply(this,arguments)}drawBackCanvas(){P.prototype.drawBackCanvas.apply(this,arguments)}renderInfo(t,e=10,i){P.prototype.renderInfo.apply(this,arguments)}drawNode(t,e){P.prototype.drawNode.apply(this,arguments)}drawLinkTooltip(t,e){P.prototype.drawLinkTooltip.apply(this,arguments)}drawNodeShape(t,e,i,n,s,r,a){P.prototype.drawNodeShape.apply(this,arguments)}drawConnections(t){P.prototype.drawConnections.apply(this,arguments)}renderLink(t,e,i,n,s,r,a,l,o,u){P.prototype.renderLink.apply(this,arguments)}computeConnectionPoint(t,e,i,n=I.RIGHT,s=I.LEFT){return P.prototype.computeConnectionPoint.apply(this,arguments)}drawExecutionOrder(t){P.prototype.drawExecutionOrder.apply(this,arguments)}drawNodeWidgets(t,e,i,n){P.prototype.drawNodeWidgets.apply(this,arguments)}drawGroups(t,e){P.prototype.drawGroups.apply(this,arguments)}};let T=de;T.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",T.node_colors={red:{color:"#322",bgColor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgColor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgColor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgColor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgColor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgColor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgColor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgColor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgColor:"#000",groupcolor:"#444"}},T.link_type_colors={[k.ACTION]:h.ACTION_LINK_COLOR,[k.EVENT]:h.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},T.active_canvas=null,T.active_node=null,T.onMenuCollapseAll=N.onMenuCollapseAll,T.onMenuNodeEdit=N.onMenuNodeEdit,T.onShowPropertyEditor=N.onShowPropertyEditor,T.onGroupAdd=N.onGroupAdd,T.onMenuAdd=N.onMenuAdd,T.showMenuNodeOptionalInputs=N.showMenuNodeOptionalInputs,T.showMenuNodeOptionalOutputs=N.showMenuNodeOptionalOutputs,T.onShowMenuNodeProperties=N.onShowMenuNodeProperties,T.onResizeNode=N.onResizeNode,T.onMenuResizeNode=N.onMenuResizeNode,T.onMenuNodeCollapse=N.onMenuNodeCollapse,T.onMenuNodePin=N.onMenuNodePin,T.onMenuNodeMode=N.onMenuNodeMode,T.onMenuNodeColors=N.onMenuNodeColors,T.onMenuNodeShapes=N.onMenuNodeShapes,T.onMenuNodeRemove=N.onMenuNodeRemove,T.onMenuNodeClone=N.onMenuNodeClone,T.onMenuNodeToSubgraph=N.onMenuNodeToSubgraph;class ge extends te{constructor(e){super(e),this.properties={name:"",type:"number",value:0},this.nameInGraph="",this.size=[180,90];let i=this;this.nameWidget=this.addWidget("text","Name",this.properties.name,function(n){n&&i.setProperty("name",n)}),this.typeWidget=this.addWidget("text","Type",""+this.properties.type,function(n){n&&i.setProperty("type",n)}),this.valueWidget=this.addWidget("number","Value",this.properties.value,function(n){i.setProperty("value",n)}),this.widgets_up=!0}onConfigure(){this.updateType()}updateType(){var e=this.properties.type;this.typeWidget.value=""+e,this.outputs[0].type!=e&&(h.isValidConnection(this.outputs[0].type,e)||this.disconnectOutput(0),this.outputs[0].type=e),e=="number"?(this.valueWidget.type="number",this.valueWidget.value=0):e=="boolean"?(this.valueWidget.type="toggle",this.valueWidget.value=!0):e=="string"?(this.valueWidget.type="text",this.valueWidget.value=""):(this.valueWidget.type=null,this.valueWidget.value=null),this.properties.value=this.valueWidget.value,this.graph&&this.nameInGraph&&typeof e=="string"?this.graph.changeInputType(this.nameInGraph,e):console.error("Can't change GraphInput to type",e,this.graph,this.nameInGraph)}onPropertyChanged(e,i){if(e=="name"){if(i==""||i==this.nameInGraph||i=="enabled")return!1;this.graph&&(this.nameInGraph?this.graph.renameInput(this.nameInGraph,i):this.graph.addInput(i,""+this.properties.type,null)),this.nameWidget.value=i,this.nameInGraph=i}else e=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(e,i){this.properties.type==k.EVENT&&this.triggerSlot(0,i)}onExecute(){var e=this.properties.name,i=this.graph.inputs[e];if(!i){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,i.value!==void 0?i.value:this.properties.value)}onRemoved(){this.nameInGraph&&this.graph.removeInput(this.nameInGraph)}}ge.slotLayout={inputs:[{name:"",type:"number"}],outputs:[]},h.registerNodeType({class:ge,title:"Input",desc:"Input of the graph",type:"graph/input"});var Ne=(t=>(t[t.STATUS_STOPPED=1]="STATUS_STOPPED",t[t.STATUS_RUNNING=2]="STATUS_RUNNING",t))(Ne||{});const Ie=class{constructor(t){this.supported_types=null,this.vars={},this.extra={},this.inputs={},this.outputs={},this._nodes=[],this._groups=[],this._nodes_by_id={},this._nodes_executable=null,this._nodes_in_order=[],this._version=-1,this._last_trigger_time=0,this._is_subgraph=!1,this._subgraph_node=null,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.execution_timer_id=-1,this.execution_time=0,this.errors_in_execution=!1,this._input_nodes=[],h.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}getSupportedTypes(){return this.supported_types||Ie.DEFAULT_SUPPORTED_TYPES}clear(){if(this.stop(),this.status=1,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}attachCanvas(t){if(!(t instanceof T))throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}detachCanvas(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);e!=-1&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}}start(t){if(this.status!=2){this.status=2,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=h.getTime(),this.last_update_time=this.starttime,t=t||0;var e=this;if(t==0&&typeof window<"u"&&window.requestAnimationFrame){let i=function(){e.execution_timer_id==-1&&(window.requestAnimationFrame(i),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep())};this.execution_timer_id=-1,i()}else this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t)}}stop(){this.status!=1&&(this.status=1,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t=1,e=!1,i){var n=h.getTime();this.globaltime=.001*(n-this.starttime);let s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(i=i||s.length,e){for(var r=0;r<t;r++){for(var a=0;a<i;++a){var l=s[a];l.mode==j.ALWAYS&&l.onExecute&&l.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var r=0;r<t;r++){for(var a=0;a<i;++a){var l=s[a];l.mode==j.ALWAYS&&l.onExecute&&l.onExecute(null,{})}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(p){if(this.errors_in_execution=!0,h.throw_errors)throw p;h.debug&&console.log("Error during execution: "+p),this.stop()}var o=h.getTime(),u=o-n;u==0&&(u=1),this.execution_time=.001*u,this.globaltime+=.001*u,this.iteration+=1,this.elapsed_time=(o-this.last_update_time)*.001,this.last_update_time=o,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)if(this._nodes_in_order[t].onExecute){let e=this._nodes_in_order[t];this._nodes_executable.push(e)}}computeExecutionOrder(t=!1,e){for(var i=[],n=[],s={},r={},a={},l=0,m=this._nodes.length;l<m;++l){var o=this._nodes[l];if(!(t&&!o.onExecute)){s[o.id]=o;var u=0;if(o.inputs)for(var p=0,d=o.inputs.length;p<d;p++)o.inputs[p]&&o.inputs[p].link!=null&&(u+=1);u==0?(n.push(o),e&&(o._level=1)):(e&&(o._level=0),a[o.id]=u)}}for(;n.length!=0;){let y=n.shift();if(i.push(y),delete s[y.id],!!y.outputs)for(var l=0;l<y.outputs.length;l++){var c=y.outputs[l];if(!(c==null||c.links==null||c.links.length==0))for(var p=0;p<c.links.length;p++){var _=c.links[p],f=this.links[_];if(f&&!r[f.id]){var g=this.getNodeById(f.target_id);if(g==null){r[f.id]=!0;continue}e&&(!g._level||g._level<=y._level)&&(g._level=y._level+1),r[f.id]=!0,a[g.id]-=1,a[g.id]==0&&n.push(g)}}}}for(let y in s)i.push(s[y]);i.length!=this._nodes.length&&h.debug&&console.warn("something went wrong, nodes missing");for(var m=i.length,l=0;l<m;++l)i[l].order=l;i=i.sort(function(y,E){var v=y.constructor.priority||y.priority||0,b=E.constructor.priority||E.priority||0;return v==b?y.order-E.order:v-b});for(var l=0;l<m;++l)i[l].order=l;return i}getAncestors(t){for(var e=[],i=[t],n={};i.length;){var s=i.shift();if(s.inputs){!n[s.id]&&s!=t&&(n[s.id]=!0,e.push(s));for(var r=0;r<s.inputs.length;++r){var a=s.getInputNode(r);a&&e.indexOf(a)==-1&&i.push(a)}}}return e.sort(function(l,o){return l.order-o.order}),e}arrange(t=100,e=re.HORIZONTAL_LAYOUT){const i=this.computeExecutionOrder(!1,!0),n=[];for(let r=0;r<i.length;++r){const a=i[r],l=a._level||1;n[l]||(n[l]=[]),n[l].push(a)}let s=t;for(let r=0;r<n.length;++r){const a=n[r];if(!a)continue;let l=100,o=t+h.NODE_TITLE_HEIGHT;for(let u=0;u<a.length;++u){const p=a[u];p.pos[0]=e==re.VERTICAL_LAYOUT?o:s,p.pos[1]=e==re.VERTICAL_LAYOUT?s:o;const d=e==re.VERTICAL_LAYOUT?1:0;p.size[d]>l&&(l=p.size[d]);const c=e==re.VERTICAL_LAYOUT?0:1;o+=p.size[c]+t+h.NODE_TITLE_HEIGHT}s+=l+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,e=[],i=j.ALWAYS){var n=this._nodes_in_order?this._nodes_in_order:this._nodes;if(n)for(var s=0,r=n.length;s<r;++s){var a=n[s];!a[t]||a.mode!=i||(e===void 0?a[t]():e&&e.constructor===Array?a[t].apply(a,e):a[t](e))}}sendActionToCanvas(t,e=[]){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var n=this.list_of_graphcanvas[i];n[t]&&n[t].apply(n,e)}}addGroup(t){return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++,t}add(t,e={}){if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=h.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return t.id==null||t.id==-1?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e.skipComputeOrder||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}remove(t){if(t instanceof le){var e=this._groups.indexOf(t);e!=-1&&this._groups.splice(e,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]!=null&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var i=0;i<t.inputs.length;i++){var n=t.inputs[i];n.link!=null&&t.disconnectInput(i)}if(t.outputs)for(var i=0;i<t.outputs.length;i++){let l=t.outputs[i];l.links!=null&&l.links.length&&t.disconnectOutput(i)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var s=this.list_of_graphcanvas[i];s.selected_nodes[t.id]&&delete s.selected_nodes[t.id],s.node_dragged==t&&(s.node_dragged=null)}var r=this._nodes.indexOf(t);r!=-1&&this._nodes.splice(r,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}}getNodeById(t){return t==null?null:this._nodes_by_id[t]}findNodesByClass(t,e=[]){e.length=0;for(var i=0,n=this._nodes.length;i<n;++i)this._nodes[i]instanceof t&&e.push(this._nodes[i]);return e}findNodesByType(i,e=[]){var i=i.toLowerCase();e.length=0;for(var n=0,s=this._nodes.length;n<s;++n)this._nodes[n].type.toLowerCase()==i&&e.push(this._nodes[n]);return e}findNodeByTitle(t){for(var e=0,i=this._nodes.length;e<i;++e)if(this._nodes[e].title==t)return this._nodes[e];return null}findNodesByTitle(t){for(var e=[],i=0,n=this._nodes.length;i<n;++i)this._nodes[i].title==t&&e.push(this._nodes[i]);return e}getNodeOnPos(t,e,i,n){i=i||this._nodes;for(var s=null,r=i.length-1;r>=0;r--){var a=i[r];if(a.isPointInside(t,e,n))return a}return s}getGroupOnPos(t,e){for(var i=this._groups.length-1;i>=0;i--){var n=this._groups[i];if(n.isPointInside(t,e,2,!0))return n}return null}checkNodeTypes(){for(var t=!1,e=0;e<this._nodes.length;e++){var i=this._nodes[e],n=h.registered_node_types[i.type];if(i.constructor!=n.class){console.log("node being replaced by newer version: "+i.type);var s=h.createNode(i.type);t=!0,this._nodes[e]=s,s.configure(i.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,i.inputs&&(s.inputs=i.inputs.concat()),i.outputs&&(s.outputs=i.outputs.concat())}}return this.updateExecutionOrder(),t}onAction(t,e,i={}){this._input_nodes=this.findNodesByClass(ge,this._input_nodes);for(var n=0;n<this._input_nodes.length;++n){var s=this._input_nodes[n];if(s.properties.name==t){s.actionDo(t,e,i);break}}}trigger(t,e){this.onTrigger&&this.onTrigger(t,e)}addInput(t,e,i){var n=this.inputs[t];n||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:i},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e,i),this.onInputsOutputsChange&&this.onInputsOutputsChange())}setInputData(t,e){var i=this.inputs[t];i&&(i.value=e)}getInputData(t){var e=this.inputs[t];return e?e.value:null}renameInput(t,e){if(e!=t)return this.inputs[t]?this.inputs[e]?(console.error("there is already one input with that name"),!1):(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}changeInputType(t,e){if(!this.inputs[t])return!1;if(this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase())return;const i=this.inputs[t].type;return this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,i,e),!0}removeInput(t){return this.inputs[t]?(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}addOutput(t,e,i){this.outputs[t]={name:t,type:e,value:i},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e,i),this.onInputsOutputsChange&&this.onInputsOutputsChange()}setOutputData(t,e){var i=this.outputs[t];i&&(i.value=e)}getOutputData(t){var e=this.outputs[t];return e?e.value:null}renameOutput(t,e){return this.outputs[t]?this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}changeOutputType(t,e){if(!this.outputs[t])return!1;if(this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase())return;const i=this.outputs[t].type;return this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,i,e),!0}removeOutput(t){return this.outputs[t]?(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}beforeChange(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",[this])}afterChange(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",[this])}connectionChange(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")}isLive(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){var e=this.list_of_graphcanvas[t];if(e.live_mode)return!0}return!1}clearTriggeredSlots(){for(var t in this.links){var e=this.links[t];e&&e._last_time&&(e._last_time=0)}}change(){h.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.onChange&&this.onChange(this)}setDirtyCanvas(t=!1,e=!1){this.sendActionToCanvas("setDirty",[t,e])}removeLink(t){var e=this.links[t];if(e){var i=this.getNodeById(e.target_id);i&&i.disconnectInput(e.target_slot)}}serialize(){for(var t=[],e=0,i=this._nodes.length;e<i;++e)t.push(this._nodes[e].serialize());var n=[];for(const u in this.links){var s=this.links[u];if(!s.serialize){console.error("weird LLink bug, link info is not a LLink but a regular object",s);var r=J.configure(s);for(var a in s)r[a]=s[a];this.links[u]=r,s=r}n.push(s.serialize())}for(var l=[],e=0;e<this._groups.length;++e)l.push(this._groups[e].serialize());var o={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:n,groups:l,config:this.config,extra:this.extra,version:h.VERSION};return this.onSerialize&&this.onSerialize(o),o}configure(t,e){if(t){e||this.clear();var i=t.nodes;if(t.links&&t.links.constructor===Array){for(var n=[],s=0;s<t.links.length;++s){var r=t.links[s];if(!r){console.warn("serialized graph link data contains errors, skipping.");continue}var a=J.configure(r);n[a.id]=a}t.links=n}for(const c in t)c=="nodes"||c=="groups"||(this[c]=t[c]);var l=!1;if(this._nodes=[],i){for(var s=0,o=i.length;s<o;++s){var u=i[s],p=h.createNode(u.type,u.title);p||(h.debug&&console.log("Node not found or has errors: "+u.type),p=new te,p.last_serialization=u,p.has_errors=!0,l=!0),p.id=u.id,this.add(p,{skipComputeOrder:!0})}for(var s=0,o=i.length;s<o;++s){var u=i[s],p=this.getNodeById(u.id);p&&p.configure(u)}}if(this._groups.length=0,t.groups)for(var s=0;s<t.groups.length;++s){var d=new le;d.configure(t.groups[s]),this.addGroup(d)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),l}}load(t,e){var i=this;if(t.constructor===File||t.constructor===Blob){var n=new FileReader;n.addEventListener("load",function(r){var a=JSON.parse(n.result);i.configure(a),e&&e(a)}),n.readAsText(t);return}var s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.onload=function(r){if(s.status!==200){console.error("Error loading graph:",s.status,s.response);return}var a=JSON.parse(s.response);i.configure(a),e&&e(a)},s.onerror=function(r){console.error("Error loading graph:",r)}}};let be=Ie;be.DEFAULT_SUPPORTED_TYPES=["number","string","boolean"];class Te extends te{constructor(e){super(e),this.properties={name:"",type:"number"},this.nameInGraph="",this.size=[180,60],this.nameWidget=this.addWidget("text","Name",this.properties.name,"name"),this.typeWidget=this.addWidget("text","Type",""+this.properties.type,"type"),this.widgets_up=!0}onConfigure(){this.updateType()}updateType(){var e=this.properties.type;this.typeWidget&&(this.typeWidget.value=""+e),this.inputs[0].type!=e&&((e=="action"||e=="event")&&(e=k.EVENT),h.isValidConnection(this.inputs[0].type,e)||this.disconnectInput(0),this.inputs[0].type=e),this.graph&&this.nameInGraph&&typeof e=="string"?this.graph.changeOutputType(this.nameInGraph,e):console.error("Can't change GraphOutput to type",e,this.graph,this.nameInGraph)}onPropertyChanged(e,i){if(e=="name"){if(i==""||i==this.nameInGraph||i=="enabled")return!1;this.graph&&(this.nameInGraph?this.graph.renameOutput(this.nameInGraph,i):this.graph.addOutput(i,""+this.properties.type,null)),this.nameWidget.value=i,this.nameInGraph=i}else e=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(e,i){this.properties.type==k.ACTION&&this.graph.trigger(this.properties.name,i)}onExecute(){const e=this.getInputData(0);this.graph.setOutputData(this.properties.name,e)}onRemoved(){this.nameInGraph&&this.graph.removeOutput(this.nameInGraph)}}Te.slotLayout={inputs:[{name:"",type:""}],outputs:[]},h.registerNodeType({class:Te,title:"Output",desc:"Output of the graph",type:"graph/output"});class he extends te{constructor(e){super(e),this.properties={enabled:!0},this.size=[140,80],this.enabled=!0,this.subgraph=new be,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}onDblClick(e,i,n){var s=this;setTimeout(function(){n.openSubgraph(s.subgraph)},10)}onAction(e,i){this.subgraph.onAction(e,i)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var e=0;e<this.inputs.length;e++){var i=this.inputs[e],n=this.getInputData(e);this.subgraph.setInputData(i.name,n)}if(this.subgraph.runStep(),this.outputs)for(var e=0;e<this.outputs.length;e++){var s=this.outputs[e],n=this.subgraph.getOutputData(s.name);this.setOutputData(e,n)}}}sendEventToAllNodes(e,i,n){this.enabled&&this.subgraph.sendEventToAllNodes(e,i,n)}onDrawBackground(e,i,n,s){if(this.flags.collapsed)return;var r=this.size[1]-h.NODE_TITLE_HEIGHT+.5,a=h.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+r,this.size[0],h.NODE_TITLE_HEIGHT);let l=h.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+r,this.size[0]/2,h.NODE_TITLE_HEIGHT);e.fillStyle=a?"#555":"#222",e.beginPath(),this.shape==S.BOX_SHAPE?l?e.rect(0,r,this.size[0]/2+1,h.NODE_TITLE_HEIGHT):e.rect(this.size[0]/2,r,this.size[0]/2+1,h.NODE_TITLE_HEIGHT):l?e.roundRect(0,r,this.size[0]/2+1,h.NODE_TITLE_HEIGHT,[0,0,8,8]):e.roundRect(this.size[0]/2,r,this.size[0]/2+1,h.NODE_TITLE_HEIGHT,[0,0,8,8]),a?e.fill():e.fillRect(0,r,this.size[0]+1,h.NODE_TITLE_HEIGHT),e.textAlign="center",e.font="24px Arial",e.fillStyle=a?"#DDD":"#999",e.fillText("+",this.size[0]*.25,r+24),e.fillText("+",this.size[0]*.75,r+24)}onMouseDown(e,i,n){var s=this.size[1]-h.NODE_TITLE_HEIGHT+.5;return console.log(0),i[1]>s&&(i[0]<this.size[0]/2?(console.log(1),n.showSubgraphPropertiesDialog(this)):(console.log(2),n.showSubgraphPropertiesDialogRight(this))),!1}computeSize(){var e=this.inputs?this.inputs.length:0,i=this.outputs?this.outputs.length:0;return[200,Math.max(e,i)*h.NODE_SLOT_HEIGHT+h.NODE_TITLE_HEIGHT]}onSubgraphTrigger(e,i){var n=this.findOutputSlotIndexByName(e);n!=-1&&this.triggerSlot(n)}onSubgraphNewInput(e,i){var n=this.findInputSlotIndexByName(e);n==-1&&this.addInput(e,i)}onSubgraphRenamedInput(e,i){var n=this.findInputSlotIndexByName(e);if(n!=-1){var s=this.getInputInfo(n);s.name=i}}onSubgraphTypeChangeInput(e,i){var n=this.findInputSlotIndexByName(e);if(n!=-1){var s=this.getInputInfo(n);s.type=i}}onSubgraphRemovedInput(e){var i=this.findInputSlotIndexByName(e);i!=-1&&this.removeInput(i)}onSubgraphNewOutput(e,i){var n=this.findOutputSlotIndexByName(e);n==-1&&this.addOutput(e,i)}onSubgraphRenamedOutput(e,i){var n=this.findOutputSlotIndexByName(e);if(n!=-1){var s=this.getOutputInfo(n);s.name=i}}onSubgraphTypeChangeOutput(e,i){var n=this.findOutputSlotIndexByName(e);if(n!=-1){var s=this.getOutputInfo(n);s.type=i}}onSubgraphRemovedOutput(e){var i=this.findInputSlotIndexByName(e);i!=-1&&this.removeOutput(i)}getExtraMenuOptions(e,i){var n=this;return[{content:"Open",callback:function(){e.openSubgraph(n.subgraph)}}]}onResize(e){console.error("TEST subgraph resize"),e[1]+=20}serialize(){var e=te.prototype.serialize.call(this);return e.subgraph=this.subgraph.serialize(),e}clone(){var e=h.createNode(this.type),i=this.serialize();return delete i.id,delete i.inputs,delete i.outputs,e.configure(i),e}buildFromNodes(e){for(var i={},n=0,s=0;s<e.length;++s){var r=e[s];i[r.id]=r,n=Math.min(r.pos[0],n),Math.max(r.pos[0],n)}for(var s=0;s<e.length;++s){var r=e[s];if(r.inputs)for(var a=0;a<r.inputs.length;++a){var l=r.inputs[a];if(!(!l||!l.link)){var o=r.graph.links[l.link];o&&(i[o.origin_id]||this.subgraph.addInput(l.name,o.type))}}if(r.outputs)for(var a=0;a<r.outputs.length;++a){var u=r.outputs[a];if(!(!u||!u.links||!u.links.length))for(var p=!1,d=0;d<u.links.length;++d){var o=r.graph.links[u.links[d]];if(o&&!i[o.target_id]){p=!0;break}}}}}}he.slotLayout={inputs:[],outputs:[]},he.propertyLayout=[{name:"enabled",defaultValue:!0}],he.optionalSlots={outputs:[{name:"enabled",type:"boolean"}]},h.registerNodeType({class:he,title:"Subgraph",desc:"Graph inside a node",title_color:"#334",type:"basic/subgraph"}),D.BuiltInSlotShape=S,D.BuiltInSlotType=k,D.ContextMenu=Y,D.ContextMenuSpecialItem=Z,D.Dir=I,D.DragAndScale=Ce,D.GraphInput=ge,D.GraphOutput=Te,D.LConnectionKind=U,D.LGraph=be,D.LGraphCanvas=T,D.LGraphCanvas_Events=oe,D.LGraphCanvas_Rendering=P,D.LGraphCanvas_UI=N,D.LGraphGroup=le,D.LGraphNode=te,D.LGraphStatus=Ne,D.LLink=J,D.LayoutDirection=re,D.LinkRenderMode=ae,D.LinkRenderModeNames=Se,D.LiteGraph=h,D.NODE_MODE_COLORS=_e,D.NODE_MODE_NAMES=ne,D.NodeMode=j,D.SLOT_SHAPE_NAMES=ve,D.Subgraph=he,D.TitleMode=ee,D.clamp=Oe,D.getStaticProperty=me,D.getStaticPropertyOnInstance=fe,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
